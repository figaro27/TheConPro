var app;app=angular.module("estimateApp",["ui.router","ngCordova","ui.bootstrap","restangular"]),app.constant("_",window._),app.constant("AccessLevels",{anon:"anon",user:"user",administrator:"administrator",subscriber:"subscriber",concreteprotector:"concreteprotector"}),app.config(["$stateProvider","$urlRouterProvider","RestangularProvider","$locationProvider","$httpProvider","AccessLevels","Config","datepickerConfig",function(a,b,c,d,e,f,g,h){"use strict";b.otherwise("/login"),h.showWeeks=!1;var i={name:"index",url:"/",views:{"@":{templateUrl:"views/common/_layout.html"},"content@index":{templateUrl:"views/common/navigation.html",controller:"MainCtrl"},"header@index":{controller:"HeaderCtrl",templateUrl:"views/common/_header.html"}},data:{access:[f.user],pageTitle:""}},j={name:"index.login",url:"login",views:{"content@index":{controller:"LoginCtrl",templateUrl:"views/account/login.html"},"header@index":{controller:"HeaderCtrl",templateUrl:"views/common/_headerTitleOnly.html"}},data:{access:[f.anon],pageTitle:"Login"}},k={name:"index.register",url:"register",views:{"content@index":{controller:"RegisterCtrl",templateUrl:"views/account/register.html"},"header@index":{controller:"HeaderCtrl",templateUrl:"views/common/_headerTitleOnly.html"}},data:{access:[f.anon],pageTitle:"Register"}},l={name:"index.changepassword",url:"changepassword",views:{"content@index":{controller:"ChangePasswordCtrl",templateUrl:"views/account/changepassword.html"}},data:{access:[f.user],pageTitle:"Change Password"}},m={name:"index.feedback",url:"feedback",views:{"content@index":{controller:"FeedbackCtrl",templateUrl:"views/account/feedback.html"}},data:{access:[f.user],pageTitle:"Feedback"}},n={name:"index.forgotpassword",url:"forgotpassword",views:{"content@index":{controller:"RegisterCtrl",templateUrl:"views/account/forgotpassword.html"},"header@index":{controller:"HeaderCtrl",templateUrl:"views/common/_headerTitleOnly.html"}},data:{access:[f.anon],pageTitle:"Forgot Password"}},o={name:"index.leads",url:"leads/:status",views:{"content@index":{controller:"LeadsCtrl",templateUrl:"views/lead/leads.html"}},data:{access:[f.user],pageTitle:"Leads"}},p={name:"index.lead",url:"lead/:id",views:{"content@index":{controller:"LeadCtrl",templateUrl:"views/lead/lead.html"}},data:{access:[f.user],pageTitle:"Lead"}},q={name:"index.newlead",url:"newlead",views:{"content@index":{controller:"NewLeadCtrl",templateUrl:"views/lead/newlead.html"}},data:{access:[f.user],pageTitle:"New Lead"}},r={name:"index.project",url:"project/:leadid/:projectid",views:{"content@index":{controller:"ProjectCtrl",templateUrl:"views/lead/project.html"}},data:{access:[f.user],pageTitle:"Project"}},s={name:"index.projects",url:"projects/:status/:time",views:{"content@index":{controller:"ProjectsCtrl",templateUrl:"views/lead/projects.html"}},data:{access:[f.user],pageTitle:"Projects"}},t={name:"index.settings",url:"settings",views:{"content@index":{controller:"SettingsCtrl",templateUrl:"views/common/settings.html"}},data:{access:[f.user],pageTitle:"Settings"}},u={name:"index.systems",url:"systems",resolve:{models:["System",function(a){return a.GetAll({type:"maintain"})}]},views:{"content@index":{templateUrl:"views/common/list.html",controller:["$scope","$state","models",function(a,b,c){a.Models=c,a["goto"]=function(a){b.go(w.name,{id:a})},a.newmodel=v.name}]}},data:{access:[f.concreteprotector,f.administrator,f.subscriber],pageTitle:"Systems"}},v={name:"index.newsystem",url:"system/",views:{"content@index":{controller:"SystemCtrl",templateUrl:"views/system/system.html"}},data:{access:[f.concreteprotector,f.administrator,f.subscriber],pageTitle:"New System"}},w={name:"index.system",url:"system/:id",views:{"content@index":{controller:"SystemCtrl",templateUrl:"views/system/system.html"}},data:{access:[f.concreteprotector,f.administrator,f.subscriber],pageTitle:"Edit System"}},x={name:"index.colors",url:"colors",resolve:{models:["Color",function(a){return a.Get()}]},views:{"content@index":{templateUrl:"views/common/list.html",controller:["$scope","$state","models",function(a,b,c){a.Models=c,a["goto"]=function(a){b.go(z.name,{id:a})},a.newmodel=y.name}]}},data:{access:[f.concreteprotector,f.administrator,f.subscriber],pageTitle:"Colors"}},y={name:"index.newcolor",url:"color/",views:{"content@index":{controller:"ColorCtrl",templateUrl:"views/system/color.html"}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"New Color"}},z={name:"index.color",url:"color/:id",views:{"content@index":{controller:"ColorCtrl",templateUrl:"views/system/color.html"}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"Edit Color"}},A={name:"index.ingredients",url:"ingredients",resolve:{models:["Ingredient",function(a){return a.Get()}]},views:{"content@index":{templateUrl:"views/common/list.html",controller:["$scope","$state","models",function(a,b,c){a.Models=c,a["goto"]=function(a){b.go(C.name,{id:a})},a.newmodel=B.name}]}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"Ingredients"}},B={name:"index.newingredient",url:"ingredient/",views:{"content@index":{controller:"IngredientCtrl",templateUrl:"views/system/ingredient.html"}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"New Ingredient"}},C={name:"index.ingredient",url:"ingredient/:id",views:{"content@index":{controller:"IngredientCtrl",templateUrl:"views/system/ingredient.html"}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"Edit Ingredient"}},D={name:"index.patterns",url:"patterns",resolve:{models:["Pattern",function(a){return a.Get()}]},views:{"content@index":{templateUrl:"views/common/list.html",controller:["$scope","$state","models",function(a,b,c){a.Models=c,a["goto"]=function(a){b.go(F.name,{id:a})},a.newmodel=E.name}]}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"Patterns"}},E={name:"index.newpattern",url:"pattern/",views:{"content@index":{controller:"PatternCtrl",templateUrl:"views/system/pattern.html"}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"New Pattern"}},F={name:"index.pattern",url:"pattern/:id",views:{"content@index":{controller:"PatternCtrl",templateUrl:"views/system/pattern.html"}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"Edit Pattern"}},G={name:"index.team",url:"team",views:{"content@index":{controller:"TeamCtrl",templateUrl:"views/team/team.html"}},data:{access:[f.concreteprotector,f.administrator,f.subscriber],pageTitle:"My Team"}},H={name:"index.subscribe",url:"subscribe",views:{"content@index":{controller:"SubscribeCtrl",templateUrl:"views/account/subscribe.html"}},data:{access:[f.user],pageTitle:"Subscribe"}},I={name:"index.contracttemplates",url:"contracttemplates",resolve:{models:["ContractTemplate",function(a){var b={},c={};return c.storageType="contracttemplatelayout",c.searchType="use",a.Search(b,c)}]},views:{"content@index":{templateUrl:"views/common/list.html",controller:["$scope","$state","models",function(a,b,c){a.Models=c,a["goto"]=function(a){b.go(K.name,{id:a})},a.newmodel=J.name}]}},data:{access:[f.concreteprotector,f.administrator,f.subscriber],pageTitle:"Templates"}},J={name:"index.newcontracttemplate",url:"contracttemplate/",views:{"content@index":{controller:"ContractTemplateCtrl",templateUrl:"views/contracttemplate/template.html"}},data:{access:[f.concreteprotector,f.administrator,f.subscriber],pageTitle:"New Template"}},K={name:"index.contracttemplate",url:"contracttemplate/:id",views:{"content@index":{controller:"ContractTemplateCtrl",templateUrl:"views/contracttemplate/template.html"}},data:{access:[f.concreteprotector,f.administrator,f.subscriber],pageTitle:"Edit Template"}},L={name:"index.contracttemplatelayouts",url:"contracttemplatelayouts",resolve:{models:["Storage",function(a){var b={},c={};return c.storageType="contracttemplatelayout",c.searchType="use",a.Search(b,c)}]},views:{"content@index":{templateUrl:"views/common/list.html",controller:["$scope","$state","models",function(a,b,c){a.Models=c,a["goto"]=function(a){b.go(N.name,{id:a})},a.newmodel=M.name}]}},data:{access:[f.administrator],pageTitle:"Layouts"}},M={name:"index.newcontracttemplatelayout",url:"contracttemplatelayout/",views:{"content@index":{controller:"ContractTemplateLayoutCtrl",templateUrl:"views/contracttemplate/layout.html"}},data:{access:[f.administrator],pageTitle:"New Layout"}},N={name:"index.contracttemplatelayout",url:"contracttemplatelayout/:id",views:{"content@index":{controller:"ContractTemplateLayoutCtrl",templateUrl:"views/contracttemplate/layout.html"}},data:{access:[f.administrator],pageTitle:"Edit Layout"}};a.state(i),a.state(o),a.state(p),a.state(q),a.state(r),a.state(s),a.state(j),a.state(l),a.state(n),a.state(k),a.state(t),a.state(m),a.state(u),a.state(v),a.state(w),a.state(x),a.state(y),a.state(z),a.state(A),a.state(B),a.state(C),a.state(D),a.state(E),a.state(F),a.state(G),a.state(H),a.state(L),a.state(M),a.state(N),a.state(I),a.state(J),a.state(K),c.setDefaultHeaders({"Concrete-Access":"Yes"}),c.setBaseUrl(g.WebServiceEndpoint),c.setDefaultHttpFields({withCredentials:!0}),e.interceptors.push("HttpInterceptor")}]).run(["$rootScope","$state","$stateParams","$window","Authorization","Config","Log",function(a,b,c,d,e,f,g){"use strict";a.$on("$stateChangeStart",function(c,d){e.CheckToken(),e.IsAuthorized(d.data.access)||(c.preventDefault(),b.go("index.login"));var g=d.data.pageTitle;a.$broadcast(f.SetTitleEvent,g)}),a.$on("$stateChangeSuccess",function(b,c,d,e,f){a.appTargetStateName=e.name,a.appTargetStateParams=f,g.Log("changed state to "+c.name)}),a.back=function(){a.appTargetStateName&&b.go(a.appTargetStateName,a.appTargetStateParams)},a.$state=b,a.$stateParams=c,a.$broadcast(f.AppStart)}]),angular.module("estimateApp").controller("HeaderCtrl",["$scope","$rootScope","Reference","Config",function(a,b,c,d){"use strict";function e(){a.title=c.Title(),a.GoBack=function(){b.back()}}e(),b.$on(d.SetTitleEvent,function(b,c){a.title=c})}]),angular.module("estimateApp").controller("MainCtrl",[function(){"use strict";function a(){}a()}]),angular.module("estimateApp").controller("SettingsCtrl",["$scope","$state","Authorization",function(a,b,c){"use strict";function d(){a.IsInRoles=function(a){return c.IsInRole(a)},a.Logout=function(){c.Logout().then(function(){b.go("index.login")})}}d()}]),angular.module("estimateApp").directive("textarea",[function(){"use strict";return{restrict:"E",link:function(a,b){var c=20,d=b[0].offsetHeight,e=b.css("paddingLeft"),f=b.css("paddingRight"),g=angular.element("<div></div>").css({position:"absolute",top:-1e4,left:-1e4,width:b[0].offsetWidth-parseInt(e||0)-parseInt(f||0),fontSize:b.css("fontSize"),fontFamily:b.css("fontFamily"),lineHeight:b.css("lineHeight"),resize:"none"});angular.element(document.body).append(g);var h=function(){var a=function(a,b){for(var c=0,d="";b>c;c++)d+=a;return d},e=b.val().replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/&/g,"&amp;").replace(/\n$/,"<br/>&nbsp;").replace(/\n/g,"<br/>").replace(/\s{2,}/g,function(b){return a("&nbsp;",b.length-1)+" "});g.html(e),b.css("height",Math.max(g[0].offsetHeight+c,d))};a.$on("$destroy",function(){g.remove()}),b.on("keyup keydown keypress change",h)}}}]),angular.module("estimateApp").directive("modal",["$rootScope","Config",function(a,b){"use strict";return{restrict:"E",replace:!0,transclude:!0,link:function(c,d,e){c.dialogStyle={},e.width&&(c.dialogStyle.width=e.width),e.height&&(c.dialogStyle.height=e.height),c.hideModal=function(){c.show=!1},a.$on(b.Http403,function(){c.show=!0})},template:"<div class='ng-modal' ng-show='show'><div class='ng-modal-overlay' ng-click='hideModal()'></div><div class='ng-modal-dialog' ng-style='dialogStyle'><div class='row'><div class='col-md-12 text-center'>You do not have permission to perform this action.</div></div><div class='row'><div class='col-md-12 text-center'><button ng-click='hideModal()' class='btn btn-danger'>Close</button></div></div></div></div>"}}]),angular.module("estimateApp").constant("Config",{AppStart:"AppStart",AuthTokenName:"AuthToken",AuthExpiration:"AuthExpiration",AuthRoles:"AuthRoles",AuthUserName:"AuthUserName",AuthId:"AuthId",WebServiceEndpoint:"http://10.0.1.15:5000/",Http200:"HTTP:200",Http401:"HTTP:401",Http403:"HTTP:403",Http500:"HTTP:500",SetTitleEvent:"SetTitleEvent",StoreInit:"StoreInit",SubscriptionPurchased:"SubscriptionPurchased",SubscriptionExpired:"SubscriptionExpired",ProductSetup:"ProductSetup",UserAuthenticated:"UserAuthenticated"}),angular.module("estimateApp").factory("HttpInterceptor",["$q","$injector","$rootScope",function(a,b,c){"use strict";var d=this,e=b.get("Config");return d.request=function(a){var c=b.get("LocalService"),d=c.Get(e.AuthTokenName);return d&&(d=angular.fromJson(d)),d&&(a.headers.Authorization="Bearer "+d),a},d.responseError=function(d){return 401===d.status&&(c.$broadcast(e.Http401),b.get("$state").go("index.login")),403===d.status&&c.$broadcast(e.Http403,d.data.error),500===d.status&&c.$broadcast(e.Http500),a.reject(d)},d}]),angular.module("estimateApp").factory("LocalService",[function(){"use strict";var a=this;return a.Get=function(a){return localStorage.getItem(a)},a.Set=function(a,b){return localStorage.setItem(a,b)},a.Unset=function(a){return localStorage.removeItem(a)},a}]),angular.module("estimateApp").service("Reference",["$rootScope","Config","Service","ErrorHandler",function(a,b,c,d){"use strict";var e=this,f={states:"api/v1/reference/states/",generic:"api/v1/reference/generic/"};e.States=function(a){return c.GetList(f.states+a)},e.Countries=function(){return c.GetList(f.generic+"country")},e.PhoneTypes=function(){return c.GetList(f.generic+"phonetype")},e.AddressTypes=function(){return c.GetList(f.generic+"addresstype")},e.CleanError=function(a){return d.CleanError(a)},e.ProcessError=function(a,b){return d.ProcessError(a,b)},e.Statuses=[{key:"1",value:"active"},{key:"0",value:"inactive"}],e.ProjectStatuses=[{key:"estimate",value:"estimate"},{key:"current",value:"current"},{key:"complete",value:"complete"}],e.TrueFalse=[{key:!0,value:"true"},{key:!1,value:"false"}];var g="Sign In";return e.Title=function(){return g},a.$on(b.SetTitleEvent,function(a,b){g=b}),e}]),angular.module("estimateApp").service("Service",["$q","$rootScope","Config","Restangular","ErrorHandler","LocalService",function(a,b,c,d,e,f){"use strict";function g(a){f.Set(c.AuthTokenName,JSON.stringify(a.token)),f.Set(c.AuthRoles,JSON.stringify(a.roles)),f.Set(c.AuthUserName,JSON.stringify(a.name)),f.Set(c.AuthId,JSON.stringify(a.id)),f.Set(c.AuthExpiration,JSON.stringify(a.expires))}function h(){f.Unset(c.AuthTokenName),f.Unset(c.AuthRoles),f.Unset(c.AuthUserName),f.Unset(c.AuthId),f.Unset(c.AuthExpiration)}var i=this;return d.addResponseInterceptor(function(a,b,c,d,e){if(e.headers().extend){var f=JSON.parse(e.headers().renewtoken);g(f)}return e.data}),i.SetConfigAuth=function(a){return g(a)},i.UnsetConfigAuth=function(){return h()},i.Post=function(b,c){var f=a.defer(),g=[];return d.all(c).post(b,{}).then(function(a){f.resolve(a)},function(a){e.ProcessError(a,g),f.reject(g)}),f.promise},i.Put=function(b,c){var f=a.defer(),g=[];return d.one(c).customPUT(b).then(function(a){f.resolve(a)},function(a){e.ProcessError(a,g),f.reject(g)}),f.promise},i.Remove=function(b,c){var f=a.defer(),g=[];return d.one(c+"/"+b).customDELETE().then(function(a){f.resolve(a)},function(a){e.ProcessError(a,g),f.reject(g)}),f.promise},i.GetList=function(b){var c=a.defer(),f=[];return d.all(b).getList().then(function(a){c.resolve(a)},function(a){e.ProcessError(a,f),c.reject(f)}),c.promise},i.GetOne=function(b){var c=a.defer(),f=[];return d.oneUrl(b).get().then(function(a){c.resolve(a)},function(a){e.ProcessError(a,f),c.reject(f)}),c.promise},b.$on(c.Http401,function(){h()}),this}]),angular.module("estimateApp").service("Utility",function(){"use strict";var a=this;return a.PopulateModel=function(a,b){for(var c in b)a.hasOwnProperty(c)&&(a[c]=b[c])},a.UpdateScopeModels=function(a,b){var c=_.where(b,{id:a.id})[0];return c?this.PopulateModel(c,a):b.push(a),b},a.RemoveModel=function(a,b){var c=b.filter(function(b){return b.id!==a.id});return b=c},a.CapitalizeFirstLetter=function(a){return a.charAt(0).toUpperCase()+a.slice(1)},a.ValidEmail=function(a){var b=/^[a-z]+[a-z0-9._]+@[a-z]+\.[a-z.]{2,5}$/;return b.test(a)},a.ValidPhone=function(a){var b=/^\(?(\d{3})\)?[ .-]?(\d{3})[ .-]?(\d{4})$/;return b.test(a)},a}),angular.module("estimateApp").factory("uuid4",[function(){"use strict";return{generate:function(){var a="function"==typeof Date.now?Date.now():(new Date).getTime(),b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"===b?c:7&c|8).toString(16)});return b}}}]),angular.module("estimateApp").controller("FeedbackCtrl",["$rootScope","$state","$scope","Account",function(a,b,c,d){"use strict";function e(){function b(a,b){""===a.feedback&&b.push("missing feedback")}c.saving=!1,c.Model={feedback:""},c.feedback=function(e){c.saving=!0;var f=[];return e.errors=[],b(e,f),f.length>0?(e.errors=f,e.error=f.join(", "),c.saving=!1,e.error):(e.error=[],e.errors=[],void d.Feedback(e).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,c.errors=a}))},c.Cancel=function(){c.saving=!1,a.back()}}e()}]),angular.module("estimateApp").controller("LoginCtrl",["$rootScope","$state","$scope","Account",function(a,b,c,d){"use strict";function e(){c.errors={},c.model={},c.formInfo={},d.IsAuthenticated()&&b.go("index"),c.login=function(a){d.Login(a).then(function(){var a=[];a.push("index.register"),a.push("index.login"),b.go("index")},function(a){c.errors=a})}}e()}]),angular.module("estimateApp").controller("RegisterCtrl",["$state","$scope","Account",function(a,b,c){"use strict";function d(){b.errors={},b.model={},b.formInfo={},b.saving=!1,b.register=function(d){b.saving=!0,c.Register(d).then(function(){b.saving=!1,a.go("index")},function(a){b.saving=!1,b.errors=a})},b.forgotpassword=function(d){b.saving=!0,c.ForgotPassword(d).then(function(){b.saving=!1,a.go("index.login")},function(a){b.saving=!1,b.errors=a})}}d()}]),angular.module("estimateApp").controller("ChangePasswordCtrl",["$rootScope","$state","$scope","Account",function(a,b,c,d){"use strict";function e(){function e(a,b){""===a.password&&b.push("missing password"),""===a.newpassword&&b.push("missing new password"),""===a.confirmnewpassword&&b.push("missing confirmation password"),""!==a.confirmnewpassword&&""!==a.newpassword&&a.confirmnewpassword.toLowerCase()!==a.newpassword.toLowerCase()&&b.push("new password does not match confirmation password")}c.saving=!1,c.Model={password:"",newpassword:"",confirmnewpassword:""},c.ChangePassword=function(f){c.saving=!0;var g=[];return f.errors=[],e(f,g),g.length>0?(f.errors=g,f.error=g.join(", "),f.error):void d.ChangePassword(f).then(function(){c.saving=!1;var d=[];d.push("index.register"),d.push("index.login");var e=_.contains(d,a.appTargetStateName);a.appTargetStateName&&!e?a.back():b.go("index")},function(a){f.errors=a,c.saving=!1,f.error=f.errors.join(", ")})},c.Cancel=function(){a.back()}}e()}]),angular.module("estimateApp").controller("SubscribeCtrl",["$rootScope","$state","$scope","Account","IAP","Config","Log",function(a,b,c,d,e,f,g){"use strict";function h(){c.Buy=function(a){e.Buy(a)},c.Test=function(){e.Test()},c.Cancel=function(){c.saving=!1,a.back()}}c.Products=e.products,a.$on(f.ProductSetup,function(){c.Products=e.products}),a.$on(f.SubscriptionPurchased,function(){g.Log("subscription purchased")}),a.$on(f.SubscriptionExpired,function(){g.Log("subscription expired")}),h()}]),angular.module("estimateApp").controller("ContractTemplateCtrl",["$rootScope","$state","$scope","$stateParams","ContractTemplate","$cordovaCamera","Storage","$q","Reference","Log","$window",function(a,b,c,d,e,f,g,h,i,j,k){"use strict";function l(){function b(a){var b=[],d={populate:!0,searchType:"use",storageType:"contracttemplateheader"},f={populate:!0,searchType:"use",storageType:"contracttemplateterm"},j={populate:!0,searchType:"use",storageType:"contracttemplatefooter"},k={fid:a};b.push(e.Get(a)),b.push(g.Search(k,d)),b.push(g.Search(k,j)),b.push(g.Search(k,f)),h.all(b).then(function(a){l(a[0][0]),m(a[1][0]),n(a[2][0]),o(a[3][0])},function(a){i.ProcessError(a,c.errors)})}function l(a){a&&(c.Model=a,c.Model.header={id:0,data:""},c.Model.term={id:0,data:""},c.Model.footer={id:0,data:""})}function m(a){a&&(c.Model.header=a,c.HeaderModelPrime=angular.copy(a))}function n(a){a&&(c.Model.footer=a,c.FooterModelPrime=angular.copy(a))}function o(a){a&&(c.Model.term=a,c.TermModelPrime=angular.copy(a))}function p(){var a={},b={};b.storageType="contracttemplatelayout",b.searchType="use",g.Search(a,b).then(function(a){c.Layouts=a},function(){})}function q(a,b){""===a.name&&b.push("missing name"),""===a.type&&b.push("missing print layout"),""===a.layoutid&&b.push("missing contract format")}function r(a,b,c,d,e){c.data!==d.data&&(0===c.id?""!==d.data&&(d.type=e,d.fid=a,b.push(g.Add(d))):(c.data!==d.data&&""!==d.data&&b.push(g.Update(d)),c.data!==d.data&&""===d.data&&b.push(g.Remove(c.id))))}function s(){}function t(a){j.Log("file too large "+a);var b="The image that you chose is too large, please select an images that is less than 100KB in size.";if(navigator&&navigator.notification)navigator.notification.alert(b,s,"File Too Large","Ok");else{k.alert(b)}}c.saving=!1,c.Model={name:"",type:"",layout:"",header:{id:0,data:""},term:{id:0,data:""},footer:{id:0,data:""}},c.HeaderModelPrime={id:0,data:""},c.FooterModelPrime={id:0,data:""},c.TermModelPrime={id:0,data:""};var u={};navigator&&navigator.camera&&(u={quality:40,correctOrientation:!0,destinationType:Camera.DestinationType.DATA_URL,encodingType:Camera.EncodingType.PNG,sourceType:Camera.PictureSourceType.PHOTOLIBRARY}),c.Layouts=[],d.id&&b(d.id),p(),c.Cancel=function(){a.back()},c.Save=function(b){c.saving=!0;var f=[];if(b.errors=[],q(b,f),f.length>0)return b.errors=f,b.error=f.join(", "),b.error;b.error=[],b.errors=[];var g=[];d.id&&d.id.length>10?e.Update(b).then(function(){g.push(r(b.id,g,c.HeaderModelPrime,c.Model.header,"contracttemplateheader")),g.push(r(b.id,g,c.FooterModelPrime,c.Model.footer,"contracttemplatefooter")),g.push(r(b.id,g,c.TermModelPrime,c.Model.term,"contracttemplateterm"))},function(a){c.saving=!1,b.errors=a,b.error=b.errors.join(", ")}):e.Add(b).then(function(){g.push(r(b.id,g,c.HeaderModelPrime,c.Model.header,"contracttemplateheader")),g.push(r(b.id,g,c.FooterModelPrime,c.Model.footer,"contracttemplatefooter")),g.push(r(b.id,g,c.TermModelPrime,c.Model.term,"contracttemplateterm"))},function(a){c.saving=!1,b.errors=a,b.error=b.errors.join(", ")}),h.all(g).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,i.ProcessError(a,c.errors)})},c.GetImage=function(a){c.errors=[],navigator&&navigator.camera&&f.getPicture(u).then(function(b){j.Log("imageData length "+b.length),b.length>15e4?t(b.length):a.data=b},function(a){i.ProcessError(a,c.errors)})},c.RemoveImage=function(a,b){b.id=0,b.data=""}}l()}]),angular.module("estimateApp").controller("ContractTemplateLayoutCtrl",["$rootScope","$state","$scope","$stateParams","Storage","uuid4",function(a,b,c,d,e,f){"use strict";function g(){function b(a){c.saving=!0;var b={searchType:"use",populate:!0,storageType:"contracttemplatelayout"},d=[];d.push({id:a}),e.Search(d,b).then(function(a){a[0]&&(c.Model=a[0],c.saving=!1)},function(a){c.errors=a,c.saving=!1})}function g(a,b){""===a.filename&&b.push("missing name"),""===a.data&&b.push("missing layout")}c.saving=!1,c.Model={name:""},d.id&&b(d.id),c.Cancel=function(){a.back()},c.Save=function(b){c.saving=!0;var h=[];return b.errors=[],g(b,h),h.length>0?(b.errors=h,b.error=h.join(", "),b.error):(b.error=[],b.errors=[],void(d.id&&d.id.length>10?e.Update(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,b.errors=a,b.error=b.errors.join(", ")}):(b.type="contracttemplatelayout",b.fid=f.generate(),e.Add(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,b.errors=a,b.error=b.errors.join(", ")}))))}}g()}]),angular.module("estimateApp").controller("ColorCtrl",["$rootScope","$state","$scope","$stateParams","Color",function(a,b,c,d,e){"use strict";function f(){function b(a){e.Get(a).then(function(a){a[0]&&(c.Model=a[0])},function(a){c.errors=a})}function f(a,b){""===a.name&&b.push("missing name")}c.saving=!1,c.Model={name:""},d.id&&b(d.id),c.Cancel=function(){a.back()},c.Save=function(b){c.saving=!0;var g=[];return b.errors=[],f(b,g),g.length>0?(b.errors=g,b.error=g.join(", "),b.error):(b.error=[],b.errors=[],void(d.id&&d.id.length>10?e.Update(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,b.errors=a,b.error=b.errors.join(", ")}):e.Add(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,b.errors=a,b.error=b.errors.join(", ")})))}}f()}]),angular.module("estimateApp").controller("IngredientCtrl",["$rootScope","$state","$scope","$stateParams","Ingredient","Reference","Color","Pattern","IngredientColor","IngredientPattern",function(a,b,c,d,e,f,g,h,i,j){"use strict";function k(){function b(a){e.Get(a).then(function(a){a[0]&&n(a[0])},function(a){c.errors=a})}function k(a){var b=[];b.push({ingredientid:a}),i.Search(b).then(function(a){c.IngredientColors=a,o(a)},function(a){c.errors=a})}function l(a){var b=[];b.push({ingredientid:a}),j.Search(b).then(function(a){c.IngredientPatterns=a,p(a)},function(a){c.errors=a})}function m(a,b){""===a.name&&b.push("missing name"),a.coverage&&""!==a.coverage||b.push("missing coverage area"),a.purchaseprice&&""!==a.purchaseprice||b.push("missing purchase price")}function n(a){a.coverage&&(a.coverage=Number(a.coverage)),a.purchaseprice&&(a.purchaseprice=Number(a.purchaseprice)),c.Model=a}function o(a){g.Get().then(function(b){if(!a)return void(c.Colors=_.sortBy(b,"name"));var d=b;_.each(d,function(b){var c=_.where(a,{colorid:b.id})[0];c&&(b.ingredientcolorid=c.id,b.checked=!0)}),c.Colors=_.sortBy(d,"name"),q()},function(a){c.errors=a})}function p(a){h.Get().then(function(b){if(!a)return void(c.Patterns=_.sortBy(b,"name"));var d=b;_.each(d,function(b){var c=_.where(a,{patternid:b.id})[0];c&&(b.ingredientpatternid=c.id,b.checked=!0)}),c.Patterns=_.sortBy(d,"name"),r()},function(a){c.errors=a})}function q(){var a=_.where(c.Colors,{checked:!0}).length;return c.ColorsCount=a,a}function r(){var a=_.where(c.Patterns,{checked:!0}).length;return c.PatternsCount=a,a}c.saving=!1,c.Model={name:"",coverage:0,purchaseprice:0},c.PatternsCount=0,c.ColorsCount=0,d.id?(b(d.id),k(d.id),l(d.id)):(o(),p()),c.Cancel=function(){a.back()},c.Save=function(b){c.saving=!0;var g=[];return b.errors=[],m(b,g),g.length>0?(b.errors=g,b.error=g.join(", "),b.error):(b.colors=c.Colors,b.patterns=c.Patterns,b.error=[],b.errors=[],void(d.id&&d.id.length>10?e.Update(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,f.ProcessError(a,b.errors)}):e.Add(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,f.ProcessError(a,b.errors)})))},c.checkColor=function(a){var b=_.where(c.Colors,{id:a})[0];b.checked=!b.checked,q()},c.checkPattern=function(a){var b=_.where(c.Patterns,{id:a})[0];b.checked=!b.checked,r()}}k()}]),angular.module("estimateApp").controller("PatternCtrl",["$rootScope","$state","$scope","$stateParams","Pattern",function(a,b,c,d,e){"use strict";function f(){function b(a){e.Get(a).then(function(a){a[0]&&(c.Model=a[0])},function(a){c.errors=a})}function f(a,b){""===a.name&&b.push("missing name")}c.saving=!1,c.Model={name:""},d.id&&b(d.id),c.Cancel=function(){a.back()},c.Save=function(b){c.saving=!0;var g=[];return b.errors=[],f(b,g),g.length>0?(b.errors=g,b.error=g.join(", "),b.error):(b.error=[],b.errors=[],void(d.id&&d.id.length>10?e.Update(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,b.errors=a,b.error=b.errors.join(", ")}):e.Add(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,b.errors=a,b.error=b.errors.join(", ")})))}}f()}]),angular.module("estimateApp").controller("SystemCtrl",["$rootScope","$state","$scope","$stateParams","$q","System","Reference","Ingredient","SystemDetail","Authorization",function(a,b,c,d,e,f,g,h,i,j){"use strict";function k(){function b(a){c.IsNew=!1,f.Get(a,{type:"maintain"}).then(function(a){var b=a[0],d=0;b.saleprice&&(isNaN(b.saleprice)||(d=Number(b.saleprice))),b.saleprice=d,c.System=b},function(a){c.errors=a})}function e(a){var b=[];b.push({systemid:a}),i.Search(b).then(function(a){c.SystemIngredients=a,l(a)},function(a){c.errors=a})}function k(a,b){a&&""!==a.name||b.push("missing name"),a.saleprice||b.push("missing system price")}function l(a){h.Get().then(function(b){if(!a)return void(c.Ingredients=_.sortBy(b,"name"));var d=b;_.each(d,function(b){var c=_.where(a,{ingredientid:b.id})[0];c&&(b.systemdetailid=c.id,b.checked=!0,b.extra=c.extra,b.primeextra=angular.copy(b.extra),b.factor=c.factor,b.primefactor=angular.copy(b.factor),b.systemdetailversion=c.version)}),c.Ingredients=_.sortBy(d,["checked","name"]),m()},function(a){c.errors=a})}function m(){var a=_.where(c.Ingredients,{checked:!0}).length;return c.IngredientCount=a,a}c.saving=!1,c.IsInRoles=function(a){return j.IsInRole(a)},c.System={name:""},c.IsNew=!0,c.IngredientCount=0,d.id?(b(d.id),e(d.id)):l(),c.Cancel=function(){a.back()},c.Save=function(b){c.saving=!0;var e=[];return b.errors=[],k(b,e),e.length>0?(b.errors=e,b.error=e.join(", "),void(c.saving=!1)):(b.ingredients=c.Ingredients,b.error=[],b.errors=[],void(d.id&&d.id.length>10?f.Update(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,g.ProcessError(a,b.errors)}):f.Add(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,g.ProcessError(a,b.errors)})))},c.checkIngredient=function(a){var b=_.where(c.Ingredients,{id:a})[0];b.checked=!b.checked,m()},c.StatusOptions=f.StatusOptions,c.FactorOptions=f.FactorOptions}k()}]),angular.module("estimateApp").controller("TeamCtrl",["$scope","$stateParams","$rootScope","$window","Team","Reference","Authorization","Utility",function(a,b,c,d,e,f,g,h){"use strict";function i(){function b(){e.Get(g).then(function(b){_.each(b,function(a){e.PopulatePermissions(a),a.system=0,a.person=0,a.financial=0,a.contract=0,a.readsystem&&(a.system=1),a.editsystem&&(a.system=2),a.readlead&&(a.person=1),a.editlead&&(a.person=2),a.readfinancial&&(a.financial=1),a.editfinancial&&(a.financial=2),a.readcontract&&(a.contract=1),a.editcontract&&(a.contract=2)}),a.Members=_.sortBy(b,"email")},function(b){a.errors=b})}function f(a){a.errors=[],h.ValidEmail(a.email)||a.errors.push(a.email+" is not a valid email")}a.Members=[],a.Member={},a.saving=!1;var g={mode:"use",populate:!0};b(),a.CancelEdit=function(){a.editing=!1},a.NewMember=function(){a.Member={email:"",readsystem:!1,editsystem:!1,readlead:!1,editlead:!1,readfinancial:!1,editfinancial:!1,readcontract:!1,editcontract:!1},a.editing=!0,a.isNew=!0},a.EditMember=function(b,c){a.Member={},a.isNew=!1,a.MemberPrime=b,a.MemberPrimeIndex=c,a.Member=angular.copy(b),e.PopulatePermissions(a.Member),a.editing=!0},a.CancelEdit=function(){a.editing=!1,a.Member={}},a.Save=function(c){return a.saving=!0,f(c),c.errors.length>0?void(a.saving=!1):(e.CalculatePermissions(c),void(c.id&&c.id.length>10?e.Update(c).then(function(){a.saving=!1,a.editing=!1,b()},function(b){a.saving=!1,c.errors=b,c.error=c.errors.join(", ")}):e.Add(c).then(function(){a.saving=!1,a.editing=!1,b()},function(b){a.saving=!1,c.errors=b,c.error=c.errors.join(", ")})))},a.Cancel=function(){c.back()},a.RemoveMember=function(b){function c(c){1===c&&b.id&&e.Remove(b.id).then(function(){a.Members.splice(a.MemberPrimeIndex,1),a.editing=!1},function(a){d.alert(a)})}if(navigator&&navigator.notification)navigator.notification.confirm("Are you absolutely sure you want to remove this team member?",c,"Delete Team Member",["Yes","No"]);else{var f=d.confirm("Are you absolutely sure you want to remove this team member?");f&&c(1)}}}i()}]),angular.module("estimateApp").service("Team",["$q","Service",function(a,b){"use strict";var c=this,d={search:"api/v1/team/search",add:"api/v1/team",remove:"api/v1/team",update:"api/v1/team"};
return c.Get=function(a){var c={};return c.criteria=a.critera?a.criteria:[],c.mode=a.mode?a.mode:"use",c.populate=a.populate?a.populate:!0,a.permission&&(c.permission=a.permission),b.Post(c,d.search)},c.Add=function(c){var e=a.defer();return b.Post(c,d.add).then(function(a){return e.resolve(a)},function(a){return e.reject(a)}),e.promise},c.Update=function(c){var e=a.defer();return b.Put(c,d.update).then(function(a){return e.resolve(a)},function(a){return e.reject(a)}),e.promise},c.Remove=function(a){return b.Remove(a,d.remove)},c.CalculatePermissions=function(a){a.permission=0,a.readsystem&&(a.permission+=this.Permissions.ReadSystem),a.editsystem&&(a.permission+=this.Permissions.EditSystem),a.readlead&&(a.permission+=this.Permissions.ReadPerson),a.editlead&&(a.permission+=this.Permissions.EditPerson),a.readfinancial&&(a.permission+=this.Permissions.ReadFinancial),a.editfinancial&&(a.permission+=this.Permissions.EditFinancial),a.readcontract&&(a.permission+=this.Permissions.ReadContract),a.editcontract&&(a.permission+=this.Permissions.EditContract)},c.PopulatePermissions=function(a){a.readsystem=(a.permission&this.Permissions.ReadSystem)>0,a.editsystem=(a.permission&this.Permissions.EditSystem)>0,a.readlead=(a.permission&this.Permissions.ReadPerson)>0,a.editlead=(a.permission&this.Permissions.EditPerson)>0,a.readfinancial=(a.permission&this.Permissions.ReadFinancial)>0,a.editfinancial=(a.permission&this.Permissions.EditFinancial)>0,a.readcontract=(a.permission&this.Permissions.ReadContract)>0,a.editcontract=(a.permission&this.Permissions.EditContract)>0},c.Permissions={ReadSystem:1,EditSystem:2,ReadPerson:4,EditPerson:8,ReadFinancial:16,EditFinancial:32,ReadContract:64,EditContract:128},c}]),angular.module("estimateApp").service("Account",["$rootScope","$q","Config","Authorization","Reference",function(a,b,c,d,e){"use strict";var f=this;return f.IsAuthenticated=function(){return d.IsAuthenticated()},f.Verify=function(a,c){var e=b.defer();try{return d.Verify(a).then(function(a){c(!0,a),e.resolve(a)},function(a){return c(!1,a),e.reject(a)}),e.promise}catch(f){return e.reject(f),e.promise}},f.Register=function(a){var c=b.defer(),f={firstname:"",lastname:"",username:"",password:""},g=[];if(a.firstname&&0!==a.firstname.length?f.firstname=a.firstname:g.push("missing first name"),a.lastname&&0!==a.lastname.length?f.lastname=a.lastname:g.push("missing last name"),a.password&&0!==a.password.length?f.password=a.password:g.push("missing password"),a.confirmpassword&&0!==a.confirmpassword.length||g.push("missing confirmation password"),a.confirmpassword&&a.password&&a.confirmpassword!==a.password&&g.push("password and confirmation password do not match"),a.username&&0!==a.username.length?f.username=a.username:g.push("missing email address"),g.length>0)return c.reject(g),c.promise;try{return d.Register(f).then(function(a){c.resolve(a)},function(a){return e.ProcessError(a,g),c.reject(g),c.promise}),c.promise}catch(h){return c.reject(h),c.promise}},f.ExtendToken=function(){var a=b.defer(),c=[];try{return d.ExtendToken().then(function(b){a.resolve(b)},function(b){return e.ProcessError(b,c),a.reject(c),a.promise}),a.promise}catch(f){return a.reject(f),a.promise}},f.Login=function(f){var g=b.defer(),h={username:"",password:""},i=[];return f.username&&0!==f.username.length?h.username=f.username:i.push("missing username"),f.password&&0!==f.password.length?h.password=f.password:i.push("missing password"),i.length>0&&g.reject(i),d.Login(h).then(function(b){a.$broadcast(c.UserAuthenticated),g.resolve(b)},function(a){e.ProcessError(a,i),g.reject(i)}),g.promise},f.ChangePassword=function(a){var c=b.defer(),f={newpassword:"",password:""},g=[];return a.password&&0!==a.password.length?f.password=a.password:g.push("missing password"),a.newpassword&&0!==a.newpassword.length?f.newpassword=a.newpassword:g.push("missing new password"),g.length>0&&c.reject(g),d.ChangePassword(f).then(function(a){c.resolve(a)},function(a){e.ProcessError(a,g),c.reject(g)}),c.promise},f.ForgotPassword=function(a){var c=b.defer(),f={username:""},g=[];return a.username&&0!==a.username.length?f.username=a.username:g.push("missing username"),g.length>0&&c.reject(g),d.ForgotPassword(f).then(function(a){c.resolve(a)},function(a){e.ProcessError(a,g),c.reject(g)}),c.promise},f.Feedback=function(a){var c=b.defer(),f=[];return a.feedback&&0!==a.feedback.length||f.push("missing feedback"),f.length>0?c.reject(f):(d.Feedback(a).then(function(a){return c.resolve(a)},function(a){return e.ProcessError(a,f),c.reject(f)}),c.promise)},f}]),angular.module("estimateApp").factory("Authorization",["$q","LocalService","AccessLevels","Config","Service",function(a,b,c,d,e){"use strict";function f(a){var c=JSON.parse(b.Get(d.AuthRoles));return c?_.intersection(c,a).length>0:!0}var g=this,h={login:"api/v1/account/login",verify:"api/v1/account/verify",register:"api/v1/account/register",feedback:"api/v1/account/feedback",forgotpassword:"api/v1/account/forgotpassword",extendtoken:"/api/v1/account/extend",changepassword:"api/v1/account/changepassword"};return g.CheckToken=function(){var a=b.Get(d.AuthTokenName);if(a){var c=new Date(JSON.parse(b.Get(d.AuthExpiration)));new Date>c&&e.UnsetConfigAuth()}},g.IsInRole=function(a){return f(a)},g.IsAuthorized=function(a){var b=[c.anon];return _.intersection(b,a).length>0?!0:f(a)?g.IsAuthenticated():!1},g.IsOwner=function(a){return a===JSON.parse(b.Get(d.AuthId))},g.IsAuthenticated=function(){return g.CheckToken(),b.Get(d.AuthTokenName)},g.Verify=function(b){var c=a.defer();return e.Post(b,h.verify).then(function(a){c.resolve(a)},function(a){c.reject(a)}),c.promise},g.Login=function(b){var c=a.defer();return e.Post(b,h.login).then(function(a){e.SetConfigAuth(a),c.resolve(a)},function(a){c.reject(a)}),c.promise},g.ExtendToken=function(){var b=a.defer();return e.Post({},h.extendtoken).then(function(a){e.SetConfigAuth(a),b.resolve(a)},function(a){b.reject(a)}),b.promise},g.Logout=function(){var b=a.defer();try{e.UnsetConfigAuth(),b.resolve(!0)}catch(c){b.reject(c)}return b.promise},g.Register=function(b){var c=a.defer();return e.Post(b,h.register).then(function(a){e.SetConfigAuth(a),c.resolve(a)},function(a){c.reject(a)}),c.promise},g.ForgotPassword=function(a){return e.Post(a,h.forgotpassword)},g.Feedback=function(a){return e.Post(a,h.feedback)},g.ChangePassword=function(b){var c=a.defer();return e.Post(b,h.changepassword).then(function(a){e.SetConfigAuth(a),c.resolve(a)},function(a){c.reject(a)}),c.promise},g}]),angular.module("estimateApp").service("IAP",["$q","$rootScope","$window","$cordovaDevice","Config","Log","Account",function(a,b,c,d,e,f,g){"use strict";function h(){c.store?j():i()}function i(){b.$broadcast(e.StoreInit,{loaded:!1}),f.Log("store not initialized"),n.register=function(a){f.Log("registered store "+a)},n.ready=function(){f.Log("store ready")},n.refresh=function(){f.Log("refresh store")},n.get=function(a){f.Log("get store "+a)},n.order=function(a){f.Log("store order "+a)},n.PAID_SUBSCRIPTION="paid subscription",n.DEBUG="DEBUG",n.ERROR="ERROR"}function j(){b.$broadcast(e.StoreInit,{loaded:!0}),f.Log("store initialized"),n=c.store,n.verbosity=n.ERROR,n.verify=g.Verify;var a={id:"monthly",alias:"Montly",type:n.PAID_SUBSCRIPTION},d={id:"yearly",alias:"Yearly",type:n.PAID_SUBSCRIPTION};n.register(a),n.register(d),n.ready(function(a){f.Log("store result "+a),f.Log("\\o/ STORE READY \\o/")}),n.off(function(a){f.Log("store off"),f.Log(a)}),n.refresh(),n.when(a.id).loaded(o),n.when(d.id).loaded(o),n.when(a.id).approved(function(a){a.verify(),f.Log("monthly approved")}),n.when(a.alias).verified(function(a){a.finish(),f.Log("monthly verified")}),n.when(a.alias).unverified(function(){f.Log("monthly unverified")}),n.when(a.alias).updated(function(a){f.Log("monthly updated"),a.owned?(f.Log("monthly owned"),f.Log(a),b.$broadcast(e.SubscriptionPurchased,a)):b.$broadcast(e.SubscriptionExpired,a)}),n.when(d.id).approved(function(a){a.verify(),f.Log("yearly approved")}),n.when(d.alias).verified(function(a){a.finish(),f.Log("yearly verified")}),n.when(d.alias).unverified(function(){f.Log("yearly unverified")}),n.when(d.alias).updated(function(a){f.Log("yearly updated"),a.owned?(f.Log("yearly owned"),f.Log(a),b.$broadcast(e.SubscriptionPurchased)):b.$broadcast(e.SubscriptionExpired)})}function k(a,c){if(f.Log("sync product"),0===a.length)f.Log("not possible"),m.push(c);else{var d=_.where(a,{id:c.id});f.Log("possible"),f.Log(a),0===d.length?a.push(a):d=a}b.$broadcast(c.owned===!0?e.SubscriptionPurchased:e.SubscriptionExpired),b.$broadcast(e.ProductSetup)}var l=this,m=[];l.products=m,l.Buy=function(a){n.order(a.id)},l.Test=function(){h()},b.$on(e.UserAuthenticated,function(){h()});var n={},o=function(a){f.Log("setup product");var b=_.where(m,{id:a.id});k(b,a)};return l}]),angular.module("estimateApp").service("ContractTemplate",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"contracttemplate")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").factory("Color",["Service","BaseFactory",function(a,b){"use strict";var c=function(){b.constructor.call(this,"color")},d={search:"api/v1/color/search"};return c.GetAll=function(){var b={};return b.criteria=[],a.Post(b,d.search)},c.prototype=Object.create(b.constructor.prototype),c.prototype.constructor=c,new c}]),angular.module("estimateApp").service("Ingredient",["$q","Service","IngredientColor","IngredientPattern",function(a,b,c,d){"use strict";function e(b,d){var e=a.defer(),f=[],g=0;return _.each(d,function(a){g+=1;var d={};a.ingredientcolorid?a.checked===!1&&f.push(c.Remove(a.ingredientcolorid)):a.checked===!0&&(d.ingredientid=b,d.colorid=a.id,f.push(c.Add(d)))}),g===d.length?e.resolve(f):e.promise}function f(b,c){var e=a.defer(),f=[],g=0;return _.each(c,function(a){g+=1;var c={};a.ingredientpatternid?a.checked===!1&&f.push(d.Remove(a.ingredientpatternid)):a.checked===!0&&(c.ingredientid=b,c.patternid=a.id,f.push(d.Add(c)))}),g===c.length?e.resolve(f):e.promise}var g=this,h={search:"api/v1/ingredient/search",add:"api/v1/ingredient",update:"api/v1/ingredient"};return g.GetAll=function(){var a={};return a.criteria=[],b.Post(a,h.search)},g.Search=function(a){var c={};return c.criteria=a,b.Post(c,h.search)},g.Get=function(a){var c={},d=[];return d.push({id:a}),c.criteria=d,b.Post(c,h.search)},g.Add=function(c){var d=a.defer();return b.Post(c,h.add).then(function(b){var g=[];g.push(e(b.id,c.colors)),g.push(f(b.id,c.patterns)),a.all(g).then(function(a){return d.resolve(a)},function(a){return d.reject(a)})},function(a){return d.reject(a)}),d.promise},g.Update=function(c){var d=a.defer();return b.Put(c,h.update).then(function(b){var g=[];g.push(e(b.id,c.colors)),g.push(f(b.id,c.patterns)),a.all(g).then(function(a){return d.resolve(a)},function(a){return d.reject(a)})},function(a){return d.reject(a)}),d.promise},g}]),angular.module("estimateApp").service("IngredientColor",["Service","BaseFactory",function(a,b){"use strict";var c=function(){b.constructor.call(this,"ingredientcolor")},d={search:"api/v1/ingredientcolor/search"};return c.GetAll=function(){var b={};return b.criteria=[],a.Post(b,d.search)},c.prototype=Object.create(b.constructor.prototype),c.prototype.constructor=c,new c}]),angular.module("estimateApp").service("IngredientPattern",["Service","BaseFactory",function(a,b){"use strict";var c=function(){b.constructor.call(this,"ingredientpattern")},d={search:"api/v1/ingredientpattern/search"};return c.GetAll=function(){var b={};return b.criteria=[],a.Post(b,d.search)},c.prototype=Object.create(b.constructor.prototype),c.prototype.constructor=c,new c}]),angular.module("estimateApp").factory("Pattern",["Service","BaseFactory",function(a,b){"use strict";var c=function(){b.constructor.call(this,"pattern")},d={search:"api/v1/pattern/search"};return c.GetAll=function(){var b={};return b.criteria=[],a.Post(b,d.search)},c.prototype=Object.create(b.constructor.prototype),c.prototype.constructor=c,new c}]),angular.module("estimateApp").service("System",["$q","Service","SystemDetail",function(a,b,c){"use strict";function d(b,d){var e=a.defer(),f=[],g=0;return _.each(d,function(a){g+=1;var d={};if(a.systemdetailid){var e="";(a.extra||a.primeextra)&&a.extra!==a.primeextra&&(e="update"),(a.factor||a.primefactor)&&a.factor!==a.primefactor&&(e="update"),a.checked===!1&&(e="delete"),"update"===e&&(d.id=a.systemdetailid,d.extra=a.extra,d.factor=a.factor,d.version=a.systemdetailversion,f.push(c.Update(d))),"delete"===e&&f.push(c.Remove(a.systemdetailid))}else a.checked===!0&&(d.systemid=b,d.ingredientid=a.id,a.extra&&(d.extra=a.extra),d.factor=a.factor,f.push(c.Add(d)))}),g===d.length?e.resolve(f):e.promise}var e=this,f={search:"api/v1/system/search",add:"api/v1/system",update:"api/v1/system"};return e.GetSystems=function(a,c){var d={},e=[];return a&&e.push({populate:"true"}),d.criteria=e,d.searchType=c,b.Post(d,f.search)},e.GetSystem=function(a,c,d){var e={},g=[];return g.push({id:a}),c&&g.push({populate:"true"}),e.criteria=g,e.searchType=d,b.Post(e,f.search)},e.GetAll=function(a){var c={};return c.searchType=a,c.criteria=[],b.Post(c,f.search)},e.Get=function(a,c){var d={},e=[];return e.push({id:a}),d.criteria=e,d.searchType=c,b.Post(d,f.search)},e.Add=function(c){var e=a.defer();return b.Post(c,f.add).then(function(b){var f=[];f.push(d(b.id,c.ingredients)),a.all(f).then(function(a){return e.resolve(a)},function(a){return e.reject(a)})},function(a){return e.reject(a)}),e.promise},e.Update=function(c){var e=a.defer();return b.Put(c,f.update).then(function(b){var f=[];f.push(d(b.id,c.ingredients)),a.all(f).then(function(a){return e.resolve(a)},function(a){return e.reject(a)})},function(a){return e.reject(a)}),e.promise},e.StatusOptions=[{key:"1",statusDisplay:"active"},{key:"0",statusDisplay:"inactive"}],e.FactorOptions=[{key:"1",display:"1"},{key:"2",display:"2"},{key:"3",display:"3"},{key:"4",display:"4"},{key:"5",display:"5"},{key:"6",display:"6"},{key:"7",display:"7"},{key:"8",display:"8"},{key:"9",display:"9"},{key:"10",display:"10"}],e}]),angular.module("estimateApp").service("SystemDetail",["Service","BaseFactory",function(a,b){"use strict";var c=function(){b.constructor.call(this,"systemdetail")},d={search:"api/v1/systemdetail/search"};return c.GetAll=function(){var b={};return b.criteria=[],a.Post(b,d.search)},c.prototype=Object.create(b.constructor.prototype),c.prototype.constructor=c,new c}]),angular.module("estimateApp").controller("EstimatesCtrl",["$scope","$stateParams","$state","Project",function(a,b,c,d){"use strict";function e(){a.Estimates=[];var e=!1,f=!1;b.id>0&&(f=b.id),""!==b.time&&(e=b.time),d.GetProjectDetails(e,f).then(function(b){a.Estimate=b},function(b){a.errors=b}),a.Edit=function(){c.go("index.project",{id:b.id})}}e()}]),angular.module("estimateApp").controller("NewLeadCtrl",["$scope","$stateParams","$state","$rootScope","Lead","Authorization","Reference","System","SystemDetail","Ingredient","$window",function(a,b,c,d,e,f,g,h,i,j,k){"use strict";function l(){function b(b){if(a.System={},b){var c=_.where(a.Systems,{id:b})[0];c.saleprice=Number(c.saleprice),a.System=c,i()}}function c(b){a.System={},b.saleprice=Number(b.saleprice),a.System=b,i()}function i(){var b=a.LeadSystem.length||0,c=a.LeadSystem.width||0,d=(b*c).toFixed(2),e=0;_.each(a.System.ingredients,function(a){var b=(d/a.coverage*a.factor).toFixed(2),c=b*a.purchaseprice;a.contractorprice=c,a.amount=b,e+=c});var f=a.System.saleprice*d;a.System.coverage=d,a.System.price=f.toFixed(2),a.System.contractortotalprice=e.toFixed(2)}function j(b,c){if(b.firstname||b.lastname||b.company||c.push("first name, last name or company required"),b.hasaddress=!1,b.hasphone=!1,b.hasdetail=!1,b.address1&&(b.hasaddress=!0),b.address2&&(b.hasaddress=!0),b.city&&(b.hasaddress=!0),b.state&&(b.hasaddress=!0),b.zip&&(b.hasaddress=!0),b.addresstype&&(b.hasaddress=!0),b.hasaddress){b.addresses=[];var d={address1:b.address1,address2:b.address2,city:b.city,state:b.state,zip:b.zip,addresstype:b.addresstype,primary:!0};b.addresses.push(d),b.address1||(b.address1=""),b.city||(b.city=""),b.state||(b.state="OH"),b.zip||(b.zip=""),b.addresstype||(b.addresstype="home")}if(b.number&&(b.hasphone=!0),b.phonetype&&(b.hasphone=!0),b.hasphone){b.phones=[];var e={number:b.number,phonetype:b.phonetype,primary:!0};b.phones.push(e),b.number||(b.number=""),b.phonetype||(b.phonetype="home")}b.email&&(b.hasdetail=!0),b.besttimetocall&&(b.hasdetail=!0),b.hearaboutus&&(b.hasdetail=!0),b.howcanwehelp&&(b.hasdetail=!0),b.Systems=a.LeadSystems,b.note&&b.note.length>490&&c.push("note is too long")}a.LeadSystem={},a.LeadSystems=[],a.Model={},a.System={},a.saving=!1,a.IsInRoles=function(a){return f.IsInRole(a)};var l={type:"use",populate:["systemdetail","ingredient"]};h.GetAll(l).then(function(b){a.Systems=b},function(b){a.errors=b}),g.States("us").then(function(b){a.States=b},function(b){a.errors=b}),g.PhoneTypes().then(function(b){a.PhoneTypes=b},function(b){a.errors=b}),g.AddressTypes().then(function(b){a.AddressTypes=b},function(b){a.errors=b});f.IsInRole(["concreteprotector","subscriber","administrator"]);a.BestTimeToCalLOptions=e.BestTimeToCalLOptions,a.AddSystem=function(b){if(a.Model.errors=[],!b.areaname)return void a.Model.errors.push("area name required");b.length||(b.length=0),b.width||(b.width=0),b.systemid?(i(),b.System=angular.copy(a.System)):(b.systemid=a.Systems[0].id,i(),b.System=angular.copy(a.Systems[0]));var c=angular.copy(b);a.LeadSystems.push(c),a.LeadSystem={},b={},a.System={},a.showIngredients=!1},a.UpdateSystem=function(b){return a.Model.errors=[],b.areaname?(b.System=angular.copy(a.System),a.LeadSystems[a.LeadSystemPrimeIndex]=b,a.LeadSystem={},a.System={},a.LeadSystemPrime={},a.LeadSystemEdit=!1,void(a.showIngredients=!1)):void a.Model.errors.push("area name required")},a.RemoveSystem=function(b,c){function d(d){1===d&&(b.id?b.visible=!1:a.LeadSystems.splice(c,1),a.LeadSystem={},a.System={},a.LeadSystemPrime={},a.LeadSystemEdit=!1,a.showIngredients=!1)}var e="Are you absolutely sure you want to remove this area:  "+b.areaname+"?";if(navigator&&navigator.notification)navigator.notification.confirm(e,d,"Delete",["Yes","No"]);else{var f=k.confirm(e);f&&d(1)}},a.EditSystem=function(b,d){a.LeadSystem={},a.System={},a.LeadSystemPrime=b,a.LeadSystemPrimeIndex=d,a.LeadSystem=angular.copy(b),c(a.LeadSystem.System),a.LeadSystemEdit=!0,a.showIngredients=!1},a.CancelUpdateSystem=function(){a.LeadSystemPrime={},a.LeadSystem={},a.System={},a.LeadSystemEdit=!1,a.showIngredients=!1},a.SystemChange=function(a){b(a)},a.AreaChanged=function(){i()},a.SaveLead=function(b){a.saving=!0;{var c=[];this.leadform}return b.Errors=[],j(b,c),c.length>0?(b.errors=c,b.error=c.join(", "),a.saving=!1,b.error):(b.error=[],b.errors=[],void e.Add(b).then(function(){a.saving=!1,d.back()},function(c){a.saving=!1,b.errors=c,b.error=b.errors.join(", ")}))},a.Cancel=function(){a.saving=!1,d.back()}}l()}]),angular.module("estimateApp").controller("LeadCtrl",["$scope","$stateParams","$state","$rootScope","$q","Lead","Authorization","Reference","Address","Phone","$window","LeadDetail","Project","Person",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){"use strict";function o(){function c(b){a.Model=b,a.ModelPrime={},a.editingLead=!1}function k(b){a.Addresses=b,a.editingAddress=!1}function o(b){a.Phones=b,a.editingPhone=!1}function p(b){a.Estimates=b}function q(b){a.Current=b}function r(b){a.Complete=b}function s(a,b){a.person.firstname||a.person.lastname||a.person.company||b.push("first name, last name or company required"),a.hasdetail=!1,a.detail.email&&(a.hasdetail=!0),a.detail.besttimetocall&&(a.hasdetail=!0),a.detail.hearaboutus&&(a.hasdetail=!0),a.detail.howcanwehelp&&(a.hasdetail=!0)}function t(a){a.number||(a.number=""),a.type||(a.type="home")}function u(a){a.address1||(a.address1=""),a.city||(a.city=""),a.state||(a.state="OH"),a.zip||(a.zip=""),a.type||(a.type="home")}a.moreThanAUser=!1,a.DisableAddLead=!1,g.IsInRole(["concreteprotector","subscriber","administrator"])&&(a.moreThanAUser=!0,a.DisableAddLead=!0),a.Model={},a.Addresses=[],a.Phones=[];var v=[{personid:b.id}],w={searchType:"use",populate:!0,status:status},x=[];b.id&&""!==b.id&&(a.leadid=b.id,x=[],x.push(f.Get(b.id,w)),x.push(i.Search(v)),x.push(j.Search(v)),x.push(m.Search([{leadid:b.id},{time:"estimate"}])),x.push(m.Search([{leadid:b.id},{time:"current"}])),x.push(m.Search([{leadid:b.id},{time:"complete"}])),e.all(x).then(function(a){c(a[0][0]),k(a[1]),o(a[2]),p(a[3]),q(a[4]),r(a[5])},function(b){h.ProcessError(b,a.errors)})),a.IsInRoles=function(a){return g.IsInRole(a)},h.States("us").then(function(b){a.States=b},function(b){h.ProcessError(b,a.errors)}),h.PhoneTypes().then(function(b){a.PhoneTypes=b},function(b){h.ProcessError(b,a.errors)}),h.AddressTypes().then(function(b){a.AddressTypes=b},function(b){h.ProcessError(b,a.errors)}),a.StatusOptions=f.Statuses,a.BestTimeToCalLOptions=f.BestTimeToCalLOptions,a.EditLead=function(){a.ModelPrime=angular.copy(a.Model),a.editingLead=!0},a.CancelEditLead=function(){a.Model=angular.copy(a.ModelPrime),a.editingLead=!1},a.SaveLead=function(d){var g=[];if(d.Errors=[],s(d,g),g.length>0)return d.errors=g,d.error=g.join(", "),d.error;if(d.error=[],d.errors=[],x=[],x.push(n.Update(d.person)),x.push(f.Update(d)),d.detail.id)x.push(l.Update(d.detail));else if(d.hasdetail){var i={leadid:d.id,email:d.detail.email,besttimetocall:d.detail.besttimetocall,hearaboutus:d.detail.hearaboutus,howcanwehelp:d.detail.howcanwehelp};x.push(l.Add(i))}e.all(x).then(function(){f.Get(b.id,w).then(function(a){c(a[0])},function(b){h.ProcessError(b,a.errors)})},function(b){h.ProcessError(b,a.errors)})},a.EditPhone=function(b,c){a.PhoneModelIndex=c,a.PhoneModelPrime=angular.copy(b),a.PhoneModel=b,a.editingPhone=!0},a.NewPhone=function(){a.PhoneModel={},a.editingPhone=!0},a.CancelEditPhone=function(){a.Phones[a.PhoneModelIndex]=angular.copy(a.PhoneModelPrime),a.PhoneModelPrime={},a.PhoneModel={},a.editingPhone=!1},a.SavePhone=function(){var d=a.PhoneModel,g=[];if(d.Errors=[],t(d,g),g.length>0)return d.errors=g,d.error=g.join(", "),d.error;if(d.error=[],d.errors=[],x=[],d.id)x.push(j.Update(d));else{var i={personid:b.id,number:d.number,type:d.type,primary:d.primary};x.push(j.Add(i))}e.all(x).then(function(){x=[],x.push(f.Get(b.id,w)),x.push(j.Search(v)),e.all(x).then(function(a){c(a[0][0]),o(a[1])},function(b){h.ProcessError(b,a.errors)})},function(b){h.ProcessError(b,a.errors)})},a.EditAddress=function(b,c){a.AddressModelIndex=c,a.AddressModelPrime=angular.copy(b),a.AddressModel=b,a.editingAddress=!0},a.NewAddress=function(){a.AddressModel={},a.editingAddress=!0},a.CancelEditAddress=function(){a.Addresses[a.AddressModelIndex]=angular.copy(a.AddressModelPrime),a.AddressModelPrime={},a.AddressModel={},a.editingAddress=!1},a.SaveAddress=function(){var c=a.AddressModel,d=[];if(c.Errors=[],u(c,d),d.length>0)return c.errors=d,c.error=d.join(", "),c.error;if(c.error=[],c.errors=[],x=[],c.id)x.push(i.Update(c));else{var f={personid:b.id,address1:c.address1,address2:c.address2,city:c.city,state:c.state,zip:c.zip,addresstype:c.addresstype,primary:c.primary};x.push(i.Add(f))}e.all(x).then(function(){i.Search(v).then(function(a){k(a)},function(b){h.ProcessError(b,a.errors)})},function(b){h.ProcessError(b,a.errors)})},a.Cancel=function(){d.back()}}o()}]),angular.module("estimateApp").controller("LeadsCtrl",["$scope","$stateParams","$state","$rootScope","Lead","Config","Authorization",function(a,b,c,d,e,f,g){"use strict";function h(){a.moreThanAUser=!1,a.DisableAddLead=!1,g.IsInRole(["concreteprotector","subscriber","administrator"])&&(a.moreThanAUser=!0);var h="1";b.status&&(h=b.status),"1"===h?d.$broadcast(f.SetTitleEvent,"Active Leads"):"0"===h&&d.$broadcast(f.SetTitleEvent,"Inactive Leads");var i={searchType:"use",populate:!0,status:h};a.Leads=[],e.GetAll(i).then(function(b){a.moreThanAUser===!1&&b.length>9&&(a.DisableAddLead=!0),_.each(b,function(b){b.phone||(b.phone={number:""}),a.Leads.push({id:b.id,hasNames:b.person.firstname.length>0||b.person.lastname.length>0,firstname:b.person.firstname,lastname:b.person.lastname,phone:b.phone.number||"",company:b.person.company})})},function(b){a.errors=b}),a.Edit=function(){c.go("index.lead",{id:b.id})},a["goto"]=function(a){c.go("index.lead",{id:a})}}h()}]),angular.module("estimateApp").controller("ProjectCtrl",["$window","$scope","$stateParams","$q","$rootScope","Lead","Project","ProjectDetail","Config","System","ProjectDetailStyle","Storage","Person","Reference","Note","Address","$cordovaCamera","$filter",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){"use strict";function s(){function s(a){b.Lead=a}function t(a){var b=d.defer();return a.id&&36===a.id.length?b.resolve(a):u(a).then(function(a){return b.resolve(a)},function(a){b.reject(a)}),b.promise}function u(a){var c=d.defer();return a.id&&36===a.id.length?g.Update(a).then(function(a){return b.isNew=!1,b.projectid=a.id,b.Model=a,a.designconsult&&(b.Model.designconsult=new Date(a.designconsult)),a.install&&(b.Model.install=new Date(a.install)),a.completed&&(b.Model.completed=new Date(a.completed)),c.resolve(a)},function(a){return c.reject(a)}):g.Add(a).then(function(a){return b.isNew=!1,b.projectid=a.id,b.Model=a,a.designconsult&&(b.Model.designconsult=new Date(a.designconsult)),a.install&&(b.Model.install=new Date(a.install)),a.completed&&(b.Model.completed=new Date(a.completed)),c.resolve(a)},function(a){return c.reject(a)}),c.promise}function v(a){var c=d.defer();return a.id&&36===a.id.length?h.Update(a).then(function(a){return b.LeadSystem=a,b.saving=!1,c.resolve(a)},function(a){return b.saving=!1,c.reject(a)}):t(b.Model).then(function(d){a.projectid=d.id,a.saleprice=b.System.saleprice,h.Add(a).then(function(a){return b.saving=!1,b.LeadSystem=a,c.resolve(a)},function(a){return b.saving=!1,c.reject(a)})},function(a){return c.reject(a)}),c.promise}function w(){g.Search([{id:b.projectid}]).then(function(a){y(a[0])},function(a){b.LeadSystem.errors.push(a)})}function x(a){b.Notes=a}function y(a){a.designconsult&&(a.designconsult=new Date(a.designconsult),a.designconsult=r("date")(a.designconsult,"MM/dd/yyyy")),a.install&&(a.install=new Date(a.install),a.install=r("date")(a.install,"MM/dd/yyyy")),a.completed&&(a.completed=new Date(a.completed),a.completed=r("date")(a.completed,"MM/dd/yyyy")),b.Model=a,b.ModelPrime={},D(),b.manageSystem=!1,b.showIngredients=!1,b.showAreaPrice=!1,x(a.notes)}function z(a){var c=!1;a.id||(c=!0,a.projectid=b.projectid);var d=b.System,e=b.LeadSystemPrime,f=!1,g=[],h=[],i=[];a.systemid!==e.systemid&&(f=!0,e.styles&&e.styles.length>0&&_.each(e.styles,function(a){i.push(a.id)})),a.systemid=d.id,a.saleprice=j.saleprice,a.area=d.coverage,a.saleprice=d.saleprice,v(a).then(function(a){_.each(d.ingredients,function(b){A(f,b,a,h,g)}),B(h,i,g),b.saving=!1},function(a){b.saving=!1,n.ProcessError(a,b.LeadSystem.errors)})}function A(a,b,c,d,e){var f={};a?(b.style&&(f=b.style),f.projectdetailid=c.id,f.ingredientid=b.id,f.purchaseprice=b.purchaseprice,d.push(f)):b.style&&(b.style.id?(f=b.style,f.ingredientid=b.id,e.push(f)):(b.style&&(f=b.style),f.projectdetailid=c.id,f.ingredientid=b.id,f.purchaseprice=b.purchaseprice,d.push(f)))}function B(a,c,e){var f=(d.promise,[]);_.each(c,function(a){f.push(k.Remove(a))}),_.each(a,function(a){f.push(k.Add(a))}),_.each(e,function(a){f.push(k.Update(a))}),d.all(f).then(function(){w()},function(a){b.LeadSystem.errors.push(a)})}function C(a){if(b.System={},a){var c=_.where(b.Systems,{id:a})[0];c.saleprice=Number(c.saleprice),b.System=c,F()}}function D(){_.each(b.Model.details,function(a){a.System=_.where(b.Systems,{id:a.systemid})[0],a.System&&(a.System.saleprice=Number(a.saleprice))}),b.Model.saleprice&&(b.Sytem.saleprice=b.Model.saleprice),b.LeadSystems=b.Model.details}function E(a){b.System={},a&&(_.each(a.ingredients,function(a){_.where(b.LeadSystem.styles,{ingredientid:a.id})[0];a.style=_.where(b.LeadSystem.styles,{ingredientid:a.id})[0]}),b.System=a,F())}function F(){var a=b.LeadSystem.arealength||0,c=b.LeadSystem.areawidth||0,d=(a*c).toFixed(2),e=0;_.each(b.System.ingredients,function(a){var b=(d/a.coverage*a.factor).toFixed(2),c=b*a.purchaseprice;a.contractorprice=c,a.amount=b,e+=c});var f=b.System.saleprice*d;b.System.coverage=d,b.System.price=f.toFixed(2),b.System.contractortotalprice=e.toFixed(2)}function G(a){var b=[],c=d.defer(),e=_.where(a,{type:"areaimage"});return _.each(e,function(a){b.push(l.GetFileImageString(a.id))}),d.all(b).then(function(a){return _.each(e,function(b,c){b.data=a[c]}),c.resolve(e)},function(a){return c.reject(a)}),c.promise}function H(){0===b.AreaImages.length&&l.Search([{fid:b.projectid}]).then(function(a){G(a).then(function(a){b.AreaImages=a},function(a){n.ProcessError(a,b.errors)})},function(a){n.ProcessError(a,b.errors)})}function I(a){b.NewPicture=!0,b.AreaImage=a}b.projectid=c.projectid,b.leadid=c.leadid,b.AreaImages=[],b.AreaImage={},b.Signature={},b.showIngredients=!0,b.saving=!1,b.isNew=!0,b.projectid&&36===b.projectid.length&&(b.isNew=!1),b.isNew===!0&&e.$broadcast(i.SetTitleEvent,"New Estimate");var J=[],K={searchType:"use",populate:!0},L={type:"use",populate:["systemdetail","ingredient"]};J.push(f.Get(b.leadid,K)),J.push(j.GetAll(L));var M=[{personid:b.leadid}];J.push(p.Search(M)),b.isNew===!1&&J.push(g.Search([{id:b.projectid}])),d.all(J).then(function(a){s(a[0][0]),b.Systems=a[1],b.Addresses=a[2],y(a.length>3?a[3][0]:{leadid:b.Lead.id})},function(a){b.errors=a}),b.Cancel=function(){b.saving=!1,e.back()},b.EditLead=function(){b.ModelPrime=angular.copy(b.Model),b.LeadPrime=angular.copy(b.Lead),b.Model.install=r("date")(b.Model.install,"MM/dd/yyyy"),b.Model.completed=r("date")(b.Model.completed,"MM/dd/yyyy"),b.Model.designconsult=r("date")(b.Model.designconsult,"MM/dd/yyyy"),b.manageLead=!0},b.CancelLeadUpdate=function(){b.Model=angular.copy(b.ModelPrime),b.Lead=angular.copy(b.LeadPrime),b.manageLead=!1},b.SaveLead=function(a){b.Model.errors=[],b.saving=!0;var c=!1;c===!1&&b.LeadPrime.person.firstname!==b.Lead.person.firstname&&(c=!0),c===!1&&b.LeadPrime.person.lastname!==b.Lead.person.lastname&&(c=!0),c===!1&&b.LeadPrime.person.company!==b.Lead.person.company&&(c=!0);var e=[];e.push(u(a)),e.push(m.Update(b.Lead.person)),d.all(e).then(function(a){e.length>0&&(b.saving=!1,b.Lead.person=a[1])},function(a){b.saving=!1,b.Model.errors.push(a)}),b.manageLead=!1},b.NewSystem=function(){b.LeadSystemPrime={},b.LeadSystem={},b.System={},E(b.LeadSystem.System),b.manageSystem=!0},b.CancelUpdateSystem=function(){b.saving=!1,b.LeadSystemPrime={},b.LeadSystem={},b.System={},b.manageSystem=!1,b.showIngredients=!1,b.showAreaPrice=!1},b.SaveSystem=function(a){return b.LeadSystem.errors=[],b.saving=!0,a.name?(a.length||(a.length=0),a.width||(a.width=0),a.systemid||(a.systemid=b.Systems[0].id,F(),a.System=angular.copy(b.Systems[0])),void z(a)):(b.LeadSystem.errors.push("area name required"),void(b.saving=!1))},b.UpdateSystem=function(a){return b.LeadSystem.errors=[],a.areaname?(a.System=angular.copy(b.System),b.LeadSystems[b.LeadSystemPrimeIndex]=a,b.LeadSystem={},b.System={},b.LeadSystemPrime={},b.manageSystem=!1,b.showIngredients=!1,void(b.showAreaPrice=!1)):void b.LeadSystem.errors.push("area name required")},b.RemoveSystem=function(c,d){function e(a){1===a&&(c.id?c.visible=!1:b.LeadSystems.splice(d,1),b.LeadSystem={},b.System={},b.LeadSystemPrime={},b.manageSystem=!1,b.showIngredients=!1,b.showAreaPrice=!1)}var f="Are you absolutely sure you want to remove this area:  "+c.areaname+"?";if(navigator&&navigator.notification)navigator.notification.confirm(f,e,"Delete Area",["Yes","No"]);else{var g=a.confirm(f);g&&e(1)}},b.EditSystem=function(a,c){b.LeadSystem={},b.System={},b.LeadSystemPrime=a,b.LeadSystemPrimeIndex=c,b.LeadSystem=angular.copy(a),E(b.LeadSystem.System),b.manageSystem=!0},b.SystemChange=function(a){C(a)},b.AreaChanged=function(){F()},b.RemoveAreaImage=function(c,d){function e(e){1===e&&c.id&&l.Remove(c.id).then(function(){b.AreaImages.splice(d,1)
},function(b){a.alert(b)})}if(navigator&&navigator.notification)navigator.notification.confirm("Are you absolutely sure you want to remove this image?",e,"Delete Image",["Yes","No"]);else{var f=a.confirm("Are you absolutely sure you want to remove this image?");f&&e(1)}},b.TakePicture=function(){if(b.AreaImage={},b.AreaImage.errors=[],navigator&&navigator.camera){var a={quality:50,destinationType:Camera.DestinationType.DATA_URL,encodingType:Camera.EncodingType.PNG,correctOrientation:!0,targetWidth:800,targetHeight:600};q.getPicture(a).then(function(a){var b={data:a};I(b)},function(a){n.ProcessError(a,b.AreaImage.errors)})}},b.$watch("showImages",function(a,b){a===!0&&void 0===b&&H()}),b.SaveAreaImage=function(){if(b.saving=!0,b.AreaImage.errors=[],b.projectid){var a={};a.type="areaimage",a.data=b.AreaImage.data,a.fid=b.projectid,l.Add(a).then(function(a){b.saving=!1,a.data=b.AreaImage.data,b.AreaImage={},b.AreaImages.push(a)},function(a){b.saving=!1,b.AreaImage.errors.push(a)})}else t(b.Model).then(function(a){var c={};c.type="areaimage",c.data=b.AreaImage.data,c.fid=a.id,l.Add(c).then(function(a){b.saving=!1,a.data=b.AreaImage.data,b.AreaImages.push(a),b.AreaImage={}},function(a){b.saving=!1,b.AreaImage.errors.push(a)})},function(a){b.saving=!1,b.AreaImage.errors.push(a)});b.NewPicture=!1},b.CancelSaveAreaImage=function(){b.saving=!1,b.NewPicture=!1,b.AreaImage={}},b.SaveSignature=function(a){if(b.saving=!0,b.Signature.errors=[],!a.data||0===a.data.length)return void b.Signature.errors.push("signature missing");if(b.projectid)if(b.Signature.id&&36===b.Signature.id.length)l.Update(a).then(function(c){b.saving=!1,c.datadisplay="data:"+a.data,c.data=null,b.Signature=c,b.editSignature=!1},function(a){b.saving=!1,b.Signature.errors.push(a)});else{var c={};c.type="signature",c.data=a.data,c.fid=b.projectid,c.filename="signature",l.Add(c).then(function(c){b.saving=!1,c.data=null,c.datadisplay="data:"+a.data,b.Signature=c,b.editSignature=!1},function(a){b.saving=!1,b.Signature.errors.push(a)})}else t(b.Model).then(function(c){var d={};d.type="signature",d.data=a.data,d.fid=c.id,d.filename="signature",l.Add(d).then(function(c){b.saving=!1,c.data=null,c.datadisplay="data:"+a.data,b.Signature=c,b.editSignature=!1},function(a){b.saving=!1,b.Signature.errors.push(a)})},function(a){b.saving=!1,b.Signature.errors.push(a)})},b.CancelSaveSignature=function(){b.saving=!1,b.Signature=angular.copy(b.SignaturePrime),b.editSignature=!1},b.EditSignature=function(){b.saving=!1,b.SignaturePrime=angular.copy(b.Signature),b.editSignature=!0},b.ProjectStatuses=n.ProjectStatuses,b.SaveNote=function(a){return b.saving=!0,a&&a.note?(b.saving=!1,void t(b.Model).then(function(c){var d={fid:c.id,body:a.note};o.Add(d).then(function(){b.saving=!1,b.saving=!1,o.Search([{fid:c.id}]).then(function(a){x(a),b.NewNote={}})},function(a){b.saving=!1,n.ProcessError(a,b.errors)})},function(a){b.saving=!1,n.ProcessError(a,b.errors)})):void(b.saving=!1)}}s()}]),angular.module("estimateApp").controller("ProjectsCtrl",["$scope","$stateParams","$rootScope","Project","Config","Utility",function(a,b,c,d,e){"use strict";function f(){a.Projects=[],a.UpperTime="",a.LowerTime="",a.IdParam=!1,a.SearchPlaceholder="";var f=1,g="Active",h="current",i="Estimates";b.status.length>-1&&(f=parseInt(b.status),0===f&&(g="Inactive")),b.time&&(h=b.time,"current"===h&&(i="Current Projects",a.datename="Install Date"),"complete"===h&&(i="Complete Projects",a.datename="Complete Date"),"estimate"===h&&(i="Estimates",a.datename="Date Added"));var j=g+" "+i;c.$broadcast(e.SetTitleEvent,j),a.SearchPlaceholder="search "+j.toLocaleLowerCase();var k={searchType:"use",populate:!0},l=[{status:f},{time:h}];d.Search(l,k).then(function(b){_.each(b,function(b){var c={};c.firstname=b.person.firstname,c.lastname=b.person.lastname,c.company=b.person.company,c.area=b.totalarea,c.cost=b.totalcost,c.leadid=b.leadid,c.date="",c.hasdate=!1,c.hasnames=b.person.firstname.length>0||b.person.lastname.length>0,"estimate"===h&&(c.hasdate=b.added.length>0,c.date=new Date(b.added)),"current"===h&&(c.hasdate=b.install,c.date=new Date(b.install)),"complete"===h&&(c.hasdate=b.completed,c.date=new Date(b.completed)),c.id=b.id,a.Projects.push(c)})},function(b){a.errors=b})}f()}]),angular.module("estimateApp").service("Lead",["$q","Reference","Service","Person","Address","Phone","Project","ProjectDetail","LeadDetail","Note","ProjectDetailStyle",function(a,b,c,d,e,f,g,h,i,j,k){"use strict";function l(b,d,e){var f=a.defer(),l=[],m={personid:d.id};if(l.push(c.Post(m,p.add)),b.hasphone&&l.push(n(d.id,b.phones)),b.hasdetail===!0){var o={leadid:d.id,email:b.email,besttimetocall:b.besttimetocall,hearaboutus:b.hearaboutus,howcanwehelp:b.howcanwehelp};l.push(i.Add(o))}return a.all(l).then(function(c){if(b.Systems&&b.Systems.length>0){var i={leadid:d.id,projectstatus:"estimate"};e&&(i.addressid=e.id),b.designconsultdate&&(i.designconsultdate=b.designconsultdate),g.Add(i).then(function(c){var d=[];if(_.each(b.Systems,function(a){var b={projectid:c.id,systemid:a.System.id,saleprice:a.System.saleprice,area:a.System.coverage,name:a.areaname,arealength:a.length,areawidth:a.width};d.push(h.Add(b))}),b.note){var e={fid:c.id,body:b.note};d.push(j.Add(e))}a.all(d).then(function(c){var d=0,e=[];_.each(b.Systems,function(a){var b=c[d],f=a.System.ingredients;_.each(f,function(a){var c={ingredientid:a.id,projectdetailid:b.id,colorid:a.selectedColor,patternid:a.selectedPattern};e.push(k.Add(c))}),d+=1}),a.all(e).then(function(a){return f.resolve(a)},function(a){return f.reject(a)})},function(a){return f.reject(a)})},function(a){return f.reject(a)})}else f.resolve(c)},function(a){return f.reject(a)}),f.promise}function m(a,b){var c={};return c.personid=a,c.address1=b.address1,c.address2=b.address2,c.city=b.city,c.state=b.state,c.zip=b.zip,c.type=b.type,c.primary=b.primary,c}function n(b,c){var d=a.defer(),e=[],g=0;return _.each(c,function(a){g+=1;var c={};if(a.personid){var d="";a.extra&&a.prime&&a.extra!==a.prime&&(d="update"),a.checked===!1&&(d="delete"),"update"===d&&(c.id=a.addressid,c.version=a.phoneversion,c.number=a.number,c.type=a.type,c.primary=a.primary,e.push(f.Update(c))),"delete"===d&&e.push(f.Remove(a.addressid))}else c.personid=b,c.number=a.number,c.type=a.type,c.primary=a.primary,e.push(f.Add(c))}),g===c.length?d.resolve(e):d.promise}var o=this,p={search:"api/v1/lead/search",add:"api/v1/lead",update:"api/v1/lead"};return o.Statuses=b.Statuses,o.BestTimeToCalLOptions=[{key:"Morning",time:"Morning"},{key:"Afternoon",time:"Afternoon"},{key:"Evening",time:"Evening"}],o.GetAll=function(a){var b={},d=[],e={searchType:"use",populate:!0,status:1};return a&&(e=a),b.hints=e,b.criteria=d,c.Post(b,p.search)},o.Get=function(a,b){var d={},e=[],f={searchType:"use",populate:!0};return b&&(f=b),e.push({id:a}),d.hints=f,d.criteria=e,c.Post(d,p.search)},o.Add=function(b){var c=a.defer(),f={firstname:b.firstname,lastname:b.lastname,company:b.company};return d.Add(f).then(function(a){if(b.hasaddress===!0){var d=m(a.id,b.addresses[0]);e.Add(d).then(function(d){l(b,a,d).then(function(a){return c.resolve(a)},function(a){return c.reject(a)})},function(a){return c.reject(a)})}else l(b,a).then(function(a){return c.resolve(a)},function(a){return c.reject(a)})},function(a){return c.reject(a)}),c.promise},o.Update=function(b){var d=a.defer();return c.Put(b,p.update).then(function(a){return d.resolve(a)},function(a){return d.reject(a)}),d.promise},o}]),angular.module("estimateApp").service("LeadDetail",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"leaddetail")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").service("Project",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"project")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").service("ProjectDetail",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"projectdetail")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").service("ProjectDetailStyle",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"projectdetailstyle")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").service("ErrorHandler",[function(){"use strict";function a(a){var b=_.where(c,{dirtyError:a}),e=_.indexOf(d,a);return e>-1?!1:b&&b.length>0?b[0].cleanError:_.contains(a,"duplicate key value violates unique constraint")?"this item already exists":a}var b=this,c=[{dirtyError:'error: duplicate key value violates unique constraint "ix_account_username"',cleanError:"This username is already in use"},{dirtyError:"Nobody here by that name",cleanError:"A user with that username can not be found"},{dirtyError:"missing system id",cleanError:"missing system"},{dirtyError:"missing arealength",cleanError:"missing length"},{dirtyError:"missing areawidth",cleanError:"missing width"}],d=["missing area","missing sale price"];return b.CleanError=function(b){return a(b)},b.ProcessError=function(b,c){var d=!1;if(b){if(b.config&&b.status&&b.config.url&&_.contains(b.config.url,"/api/v1/account/login")&&404===b.status&&(c.push("user not found"),d=!0),!d&&b.data){var e=b.data.error;if(e){if(!d&&-1===e.indexOf("[")){var f=e.replace(/"/g,"").replace(/, /g,",").split(",");_.each(f,function(b){var d=a(b);d&&c.push(d)}),d=!0}d||0!==e.indexOf("[")?!d&&e&&(c.push(e),d=!0):(e=JSON.parse(e),angular.forEach(e,function(b){c.push(a(b))}),d=!0)}}!d&&b.length>0&&angular.forEach(b,function(b){c.push(a(b))})}},b}]),angular.module("estimateApp").service("Person",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"person")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").service("Address",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"address")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").service("Phone",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"phone")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").service("Log",["$window",function(a){"use strict";var b=this;return b.Log=function(b){a.console&&a.console.log&&b&&a.console.log("object"==typeof b?JSON.stringify(b):b)},b}]),angular.module("estimateApp").service("Note",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"note")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").factory("BaseFactory",["Service",function(a){"use strict";function b(a){this.url={search:"api/v1/"+a+"/search",add:"api/v1/"+a,update:"api/v1/"+a,remove:"api/v1/"+a}}return b.prototype.Get=function(b){var c={},d=[];return d.push({id:b}),c.criteria=d,a.Post(c,this.url.search)},b.prototype.Search=function(b,c){var d={},e={searchType:"use",populate:!0};return c&&(e=c),d.hints=e,d.criteria=b,a.Post(d,this.url.search)},b.prototype.Add=function(b){return a.Post(b,this.url.add)},b.prototype.Update=function(b){return a.Put(b,this.url.update)},b.prototype.Remove=function(b){return a.Remove(b,this.url.remove)},new b}]),angular.module("estimateApp").service("Storage",["Service","BaseFactory",function(a){"use strict";var b=this,c={search:"api/v1/storage/search",add:"api/v1/storage",update:"api/v1/storage",remove:"api/v1/storage"};return b.GetFileImageString=function(b){return a.GetOne(c.add+"/"+b)},b.Get=function(b){var d={},e=[];return e.push({id:b}),d.criteria=e,a.Post(d,c.search)},b.Search=function(b,d){var e={},f={searchType:"use",populate:!1,storageType:""};return d&&(f=d),e.hints=f,e.criteria=b,a.Post(e,c.search)},b.Add=function(b){return a.Post(b,c.add)},b.Update=function(b){return a.Put(b,c.update)},b.Remove=function(b){return a.Remove(b,c.remove)},b}]),angular.module("estimateApp").directive("jSignature",["$timeout",function(a){"use strict";return{restrict:"EA",scope:{model:"=jSignature",penColor:"@",lineColor:"@",readonly:"=",data:"="},link:function(b,c){var d=(b.data,function(){var a="position:absolute;display:none;margin:0 !important;top:auto",b=$('<button type="button" class="btn btn-xs btn-default" style="'+a+'">Undo Last Stroke</button>').appendTo(this.$controlbarLower),c=b.width();return b.css("left",Math.round((this.canvas.width-c)/2)),b}),e={UndoButton:d};b.lineColor&&(e["decor-color"]=b.lineColor),b.penColor&&(e.color=b.penColor),c.jSignature(e),b.$watch("model",function(a){if("undefined"!=typeof a);}),b.$watch("readonly",function(a){a===!0?(c.jSignature("disable"),c.find("button").css({display:"none"})):c.jSignature("enable")}),b.$watch("data",function(){}),c.bind("change",function(){a(function(){b.data="";var a=c.jSignature("getData","svgbase64"),d=a.join(",");b.data=d,b.model=d},100,!0)})}}}]);