var app;app=angular.module("estimateApp",["ui.router","ngCordova","ui.bootstrap","restangular"]),app.constant("_",window._),app.constant("AccessLevels",{anon:"anon",user:"user",administrator:"administrator",subscriber:"subscriber",concreteprotector:"concreteprotector"}),app.config(["$stateProvider","$urlRouterProvider","RestangularProvider","$locationProvider","$httpProvider","AccessLevels","Config","datepickerConfig",function(a,b,c,d,e,f,g,h){"use strict";b.otherwise("/login"),h.showWeeks=!1;var i={name:"index",url:"/",views:{"@":{templateUrl:"views/common/_layout.html"},"content@index":{templateUrl:"views/common/navigation.html",controller:"MainCtrl"},"header@index":{controller:"HeaderCtrl",templateUrl:"views/common/_header.html"}},data:{access:[f.user],pageTitle:""}},j={name:"index.login",url:"login",views:{"content@index":{controller:"LoginCtrl",templateUrl:"views/account/login.html"},"header@index":{controller:"HeaderCtrl",templateUrl:"views/common/_headerTitleOnly.html"}},data:{access:[f.anon],pageTitle:"Login"}},k={name:"index.register",url:"register",views:{"content@index":{controller:"RegisterCtrl",templateUrl:"views/account/register.html"},"header@index":{controller:"HeaderCtrl",templateUrl:"views/common/_headerTitleOnly.html"}},data:{access:[f.anon],pageTitle:"Register"}},l={name:"index.changepassword",url:"changepassword",views:{"content@index":{controller:"ChangePasswordCtrl",templateUrl:"views/account/changepassword.html"}},data:{access:[f.user],pageTitle:"Change Password"}},m={name:"index.feedback",url:"feedback",views:{"content@index":{controller:"FeedbackCtrl",templateUrl:"views/account/feedback.html"}},data:{access:[f.user],pageTitle:"Feedback"}},n={name:"index.forgotpassword",url:"forgotpassword",views:{"content@index":{controller:"RegisterCtrl",templateUrl:"views/account/forgotpassword.html"},"header@index":{controller:"HeaderCtrl",templateUrl:"views/common/_headerTitleOnly.html"}},data:{access:[f.anon],pageTitle:"Forgot Password"}},o={name:"index.leads",url:"leads/:status",views:{"content@index":{controller:"LeadsCtrl",templateUrl:"views/lead/leads.html"}},data:{access:[f.user],pageTitle:"Leads"}},p={name:"index.lead",url:"lead/:id",views:{"content@index":{controller:"LeadCtrl",templateUrl:"views/lead/lead.html"}},data:{access:[f.user],pageTitle:"Lead"}},q={name:"index.newlead",url:"newlead",views:{"content@index":{controller:"NewLeadCtrl",templateUrl:"views/lead/newlead.html"}},data:{access:[f.user],pageTitle:"New Lead"}},r={name:"index.project",url:"project/:leadid/:projectid",views:{"content@index":{controller:"ProjectCtrl",templateUrl:"views/lead/project.html"}},data:{access:[f.user],pageTitle:"Project"}},s={name:"index.projects",url:"projects/:status/:time",views:{"content@index":{controller:"ProjectsCtrl",templateUrl:"views/lead/projects.html"}},data:{access:[f.user],pageTitle:"Projects"}},t={name:"index.settings",url:"settings",views:{"content@index":{controller:"SettingsCtrl",templateUrl:"views/common/settings.html"}},data:{access:[f.user],pageTitle:"Settings"}},u={name:"index.systems",url:"systems",resolve:{models:["System",function(a){return a.GetAll({type:"maintain"})}]},views:{"content@index":{templateUrl:"views/common/list.html",controller:["$scope","$state","models",function(a,b,c){a.Models=c,a["goto"]=function(a){b.go(w.name,{id:a})},a.newmodel=v.name}]}},data:{access:[f.concreteprotector,f.administrator,f.subscriber],pageTitle:"Systems"}},v={name:"index.newsystem",url:"system/",views:{"content@index":{controller:"SystemCtrl",templateUrl:"views/system/system.html"}},data:{access:[f.concreteprotector,f.administrator,f.subscriber],pageTitle:"New System"}},w={name:"index.system",url:"system/:id",views:{"content@index":{controller:"SystemCtrl",templateUrl:"views/system/system.html"}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"Edit System"}},x={name:"index.colors",url:"colors",resolve:{models:["Color",function(a){return a.Get()}]},views:{"content@index":{templateUrl:"views/common/list.html",controller:["$scope","$state","models",function(a,b,c){a.Models=c,a["goto"]=function(a){b.go(z.name,{id:a})},a.newmodel=y.name}]}},data:{access:[f.concreteprotector,f.administrator,f.subscriber],pageTitle:"Colors"}},y={name:"index.newcolor",url:"color/",views:{"content@index":{controller:"ColorCtrl",templateUrl:"views/system/color.html"}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"New Color"}},z={name:"index.color",url:"color/:id",views:{"content@index":{controller:"ColorCtrl",templateUrl:"views/system/color.html"}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"Edit Color"}},A={name:"index.ingredients",url:"ingredients",resolve:{models:["Ingredient",function(a){return a.Get()}]},views:{"content@index":{templateUrl:"views/common/list.html",controller:["$scope","$state","models",function(a,b,c){a.Models=c,a["goto"]=function(a){b.go(C.name,{id:a})},a.newmodel=B.name}]}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"Ingredients"}},B={name:"index.newingredient",url:"ingredient/",views:{"content@index":{controller:"IngredientCtrl",templateUrl:"views/system/ingredient.html"}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"New Ingredient"}},C={name:"index.ingredient",url:"ingredient/:id",views:{"content@index":{controller:"IngredientCtrl",templateUrl:"views/system/ingredient.html"}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"Edit Ingredient"}},D={name:"index.patterns",url:"patterns",resolve:{models:["Pattern",function(a){return a.Get()}]},views:{"content@index":{templateUrl:"views/common/list.html",controller:["$scope","$state","models",function(a,b,c){a.Models=c,a["goto"]=function(a){b.go(F.name,{id:a})},a.newmodel=E.name}]}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"Patterns"}},E={name:"index.newpattern",url:"pattern/",views:{"content@index":{controller:"PatternCtrl",templateUrl:"views/system/pattern.html"}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"New Pattern"}},F={name:"index.pattern",url:"pattern/:id",views:{"content@index":{controller:"PatternCtrl",templateUrl:"views/system/pattern.html"}},data:{access:[f.concreteprotector,f.administrator],pageTitle:"Edit Pattern"}},G={name:"index.ownership",url:"ownership",resolve:{models:["Team",function(a){return a.GetOwnership()}]},views:{"content@index":{templateUrl:"views/team/teams.html",controller:["$scope","$state","models",function(a,b,c){a.Models=c,a["goto"]=function(a){b.go("index.team",{id:a})}}]}},data:{access:[f.concreteprotector,f.administrator,f.subscriber],pageTitle:"My Teams"}},H={name:"index.membership",url:"membership",resolve:{models:["Team",function(a){return a.GetMembership()}]},views:{"content@index":{templateUrl:"views/team/teams.html",controller:["$scope","$state","models",function(a,b,c){a.Models=c,a["goto"]=function(a){b.go("index.team",{id:a})}}]}},data:{access:[f.concreteprotector,f.administrator,f.subscriber],pageTitle:"Team Membership"}},I={name:"index.newteam",url:"pattern/",views:{"content@index":{controller:"TeamCtrl",templateUrl:"views/team/team.html"}},data:{access:[f.concreteprotector,f.subscriber,f.administrator],pageTitle:"New Team"}},J={name:"index.team",url:"team/:id",views:{"content@index":{controller:"TeamCtrl",templateUrl:"views/team/team.html"}},data:{access:[f.concreteprotector,f.subscriber,f.administrator],pageTitle:"Edit Team"}};a.state(i),a.state(o),a.state(p),a.state(q),a.state(r),a.state(s),a.state(j),a.state(l),a.state(n),a.state(k),a.state(t),a.state(m),a.state(u),a.state(v),a.state(w),a.state(x),a.state(y),a.state(z),a.state(A),a.state(B),a.state(C),a.state(D),a.state(E),a.state(F),a.state(H),a.state(G),a.state(I),a.state(J),c.setDefaultHeaders({"Concrete-Access":"Yes"}),c.setBaseUrl(g.WebServiceEndpoint),c.setDefaultHttpFields({withCredentials:!0}),e.interceptors.push("HttpInterceptor")}]).run(["$rootScope","$state","$stateParams","Authorization","Config",function(a,b,c,d,e){"use strict";a.$on("$stateChangeStart",function(c,f){d.CheckToken(),d.IsAuthorized(f.data.access)||(c.preventDefault(),b.go("index.login"));var g=f.data.pageTitle;a.$broadcast(e.SetTitleEvent,g)}),a.$on("$stateChangeSuccess",function(b,c,d,e,f){a.appTargetStateName=e.name,a.appTargetStateParams=f}),a.back=function(){a.appTargetStateName&&b.go(a.appTargetStateName,a.appTargetStateParams)},a.$state=b,a.$stateParams=c}]),angular.module("estimateApp").controller("HeaderCtrl",["$scope","$rootScope","Reference","Config",function(a,b,c,d){"use strict";function e(){a.title=c.Title(),a.GoBack=function(){b.back()}}e(),b.$on(d.SetTitleEvent,function(b,c){a.title=c})}]),angular.module("estimateApp").controller("MainCtrl",[function(){"use strict";function a(){}a()}]),angular.module("estimateApp").controller("SettingsCtrl",["$scope","$state","Authorization",function(a,b,c){"use strict";function d(){a.IsInRoles=function(a){return c.IsInRole(a)},a.Logout=function(){c.Logout().then(function(){b.go("index.login")})}}d()}]),angular.module("estimateApp").directive("textarea",[function(){"use strict";return{restrict:"E",link:function(a,b){var c=20,d=b[0].offsetHeight,e=b.css("paddingLeft"),f=b.css("paddingRight"),g=angular.element("<div></div>").css({position:"absolute",top:-1e4,left:-1e4,width:b[0].offsetWidth-parseInt(e||0)-parseInt(f||0),fontSize:b.css("fontSize"),fontFamily:b.css("fontFamily"),lineHeight:b.css("lineHeight"),resize:"none"});angular.element(document.body).append(g);var h=function(){var a=function(a,b){for(var c=0,d="";b>c;c++)d+=a;return d},e=b.val().replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/&/g,"&amp;").replace(/\n$/,"<br/>&nbsp;").replace(/\n/g,"<br/>").replace(/\s{2,}/g,function(b){return a("&nbsp;",b.length-1)+" "});g.html(e),b.css("height",Math.max(g[0].offsetHeight+c,d))};a.$on("$destroy",function(){g.remove()}),b.on("keyup keydown keypress change",h)}}}]),angular.module("estimateApp").constant("Config",{AuthTokenName:"AuthToken",AuthExpiration:"AuthExpiration",AuthRoles:"AuthRoles",AuthUserName:"AuthUserName",AuthId:"AuthId",WebServiceEndpoint:"https://artapi1.natomis.com/",Http200:"HTTP:200",Http401:"HTTP:401",Http403:"HTTP:403",Http500:"HTTP:500",SetTitleEvent:"SetTitleEvent"}),angular.module("estimateApp").factory("HttpInterceptor",["$q","$injector","$rootScope",function(a,b,c){"use strict";var d=this,e=b.get("Config");return d.request=function(a){var c=b.get("LocalService"),d=c.Get(e.AuthTokenName);return d&&(d=angular.fromJson(d)),d&&(a.headers.Authorization="Bearer "+d),a},d.responseError=function(d){return 401===d.status&&(c.$broadcast(e.Http401),b.get("$state").go("index.login")),403===d.status&&c.$broadcast(e.Http403),500===d.status&&c.$broadcast(e.Http500),a.reject(d)},d}]),angular.module("estimateApp").factory("LocalService",[function(){"use strict";var a=this;return a.Get=function(a){return localStorage.getItem(a)},a.Set=function(a,b){return localStorage.setItem(a,b)},a.Unset=function(a){return localStorage.removeItem(a)},a}]),angular.module("estimateApp").service("Reference",["$rootScope","Config","Service","ErrorHandler",function(a,b,c,d){"use strict";var e=this,f={states:"api/v1/reference/states/",generic:"api/v1/reference/generic/"};e.States=function(a){return c.GetList(f.states+a)},e.Countries=function(){return c.GetList(f.generic+"country")},e.PhoneTypes=function(){return c.GetList(f.generic+"phonetype")},e.AddressTypes=function(){return c.GetList(f.generic+"addresstype")},e.CleanError=function(a){return d.CleanError(a)},e.ProcessError=function(a,b){return d.ProcessError(a,b)},e.Statuses=[{key:"1",value:"active"},{key:"0",value:"inactive"}],e.ProjectStatuses=[{key:"estimate",value:"estimate"},{key:"current",value:"current"},{key:"complete",value:"complete"}],e.TrueFalse=[{key:!0,value:"true"},{key:!1,value:"false"}];var g="Sign In";return e.Title=function(){return g},a.$on(b.SetTitleEvent,function(a,b){g=b}),e}]),angular.module("estimateApp").service("Service",["$q","$rootScope","Config","Restangular","ErrorHandler","LocalService",function(a,b,c,d,e,f){"use strict";function g(a){f.Set(c.AuthTokenName,JSON.stringify(a.token)),f.Set(c.AuthRoles,JSON.stringify(a.roles)),f.Set(c.AuthUserName,JSON.stringify(a.name)),f.Set(c.AuthId,JSON.stringify(a.id)),f.Set(c.AuthExpiration,JSON.stringify(a.expires))}function h(){f.Unset(c.AuthTokenName),f.Unset(c.AuthRoles),f.Unset(c.AuthUserName),f.Unset(c.AuthId),f.Unset(c.AuthExpiration)}var i=this;return d.addResponseInterceptor(function(a,b,c,d,e){if(e.headers().extend){var f=JSON.parse(e.headers().renewtoken);g(f)}return e.data}),i.SetConfigAuth=function(a){return g(a)},i.UnsetConfigAuth=function(){return h()},i.Post=function(b,c){var f=a.defer(),g=[];return d.all(c).post(b,{}).then(function(a){f.resolve(a)},function(a){e.ProcessError(a,g),f.reject(g)}),f.promise},i.Put=function(b,c){var f=a.defer(),g=[];return d.one(c).customPUT(b).then(function(a){f.resolve(a)},function(a){e.ProcessError(a,g),f.reject(g)}),f.promise},i.Remove=function(b,c){var f=a.defer(),g=[];return d.one(c+"/"+b).customDELETE().then(function(a){f.resolve(a)},function(a){e.ProcessError(a,g),f.reject(g)}),f.promise},i.GetList=function(b){var c=a.defer(),f=[];return d.all(b).getList().then(function(a){c.resolve(a)},function(a){e.ProcessError(a,f),c.reject(f)}),c.promise},i.GetOne=function(b){var c=a.defer(),f=[];return d.oneUrl(b).get().then(function(a){c.resolve(a)},function(a){e.ProcessError(a,f),c.reject(f)}),c.promise},b.$on(c.Http401,function(){h()}),this}]),angular.module("estimateApp").service("Utility",function(){"use strict";var a=this;return a.PopulateModel=function(a,b){for(var c in b)a.hasOwnProperty(c)&&(a[c]=b[c])},a.UpdateScopeModels=function(a,b){var c=_.where(b,{id:a.id})[0];return c?this.PopulateModel(c,a):b.push(a),b},a.RemoveModel=function(a,b){var c=b.filter(function(b){return b.id!==a.id});return b=c},a.CapitalizeFirstLetter=function(a){return a.charAt(0).toUpperCase()+a.slice(1)},a.ValidEmail=function(a){var b=/^[a-z]+[a-z0-9._]+@[a-z]+\.[a-z.]{2,5}$/;return b.test(a)},a.ValidPhone=function(a){var b=/^\(?(\d{3})\)?[ .-]?(\d{3})[ .-]?(\d{4})$/;return b.test(a)},a}),angular.module("estimateApp").factory("uuid4",[function(){"use strict";return{generate:function(){var a="function"==typeof Date.now?Date.now():(new Date).getTime(),b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"===b?c:7&c|8).toString(16)});return b}}}]),angular.module("estimateApp").controller("FeedbackCtrl",["$rootScope","$state","$scope","Account",function(a,b,c,d){"use strict";function e(){function b(a,b){""===a.feedback&&b.push("missing feedback")}c.saving=!1,c.Model={feedback:""},c.feedback=function(e){c.saving=!0;var f=[];return e.errors=[],b(e,f),f.length>0?(e.errors=f,e.error=f.join(", "),c.saving=!1,e.error):(e.error=[],e.errors=[],void d.Feedback(e).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,c.errors=a}))},c.Cancel=function(){c.saving=!1,a.back()}}e()}]),angular.module("estimateApp").controller("LoginCtrl",["$rootScope","$state","$scope","Account",function(a,b,c,d){"use strict";function e(){c.errors={},c.model={},c.formInfo={},c.login=function(a){d.Login(a).then(function(){var a=[];a.push("index.register"),a.push("index.login"),b.go("index")},function(a){c.errors=a})}}e()}]),angular.module("estimateApp").controller("RegisterCtrl",["$state","$scope","Account",function(a,b,c){"use strict";function d(){b.errors={},b.model={},b.formInfo={},b.saving=!1,b.register=function(d){b.saving=!0,c.Register(d).then(function(){b.saving=!1,a.go("index")},function(a){b.saving=!1,b.errors=a})},b.forgotpassword=function(d){b.saving=!0,c.ForgotPassword(d).then(function(){b.saving=!1,a.go("index.login")},function(a){b.saving=!1,b.errors=a})}}d()}]),angular.module("estimateApp").controller("ChangePasswordCtrl",["$rootScope","$state","$scope","Account",function(a,b,c,d){"use strict";function e(){function e(a,b){""===a.password&&b.push("missing password"),""===a.newpassword&&b.push("missing new password"),""===a.confirmnewpassword&&b.push("missing confirmation password"),""!==a.confirmnewpassword&&""!==a.newpassword&&a.confirmnewpassword.toLowerCase()!==a.newpassword.toLowerCase()&&b.push("new password does not match confirmation password")}c.saving=!1,c.Model={password:"",newpassword:"",confirmnewpassword:""},c.ChangePassword=function(f){c.saving=!0;var g=[];return f.errors=[],e(f,g),g.length>0?(f.errors=g,f.error=g.join(", "),f.error):void d.ChangePassword(f).then(function(){c.saving=!1;var d=[];d.push("index.register"),d.push("index.login");var e=_.contains(d,a.appTargetStateName);a.appTargetStateName&&!e?a.back():b.go("index")},function(a){f.errors=a,c.saving=!1,f.error=f.errors.join(", ")})},c.Cancel=function(){a.back()}}e()}]),angular.module("estimateApp").controller("ColorCtrl",["$rootScope","$state","$scope","$stateParams","Color",function(a,b,c,d,e){"use strict";function f(){function b(a){e.Get(a).then(function(a){a[0]&&(c.Model=a[0])},function(a){c.errors=a})}function f(a,b){""===a.name&&b.push("missing name")}c.saving=!1,c.Model={name:""},d.id&&b(d.id),c.Cancel=function(){a.back()},c.Save=function(b){c.saving=!0;var g=[];return b.errors=[],f(b,g),g.length>0?(b.errors=g,b.error=g.join(", "),b.error):(b.error=[],b.errors=[],void(d.id&&d.id.length>10?e.Update(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,b.errors=a,b.error=b.errors.join(", ")}):e.Add(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,b.errors=a,b.error=b.errors.join(", ")})))}}f()}]),angular.module("estimateApp").controller("IngredientCtrl",["$rootScope","$state","$scope","$stateParams","Ingredient","Reference","Color","Pattern","IngredientColor","IngredientPattern",function(a,b,c,d,e,f,g,h,i,j){"use strict";function k(){function b(a){e.Get(a).then(function(a){a[0]&&n(a[0])},function(a){c.errors=a})}function k(a){var b=[];b.push({ingredientid:a}),i.Search(b).then(function(a){c.IngredientColors=a,o(a)},function(a){c.errors=a})}function l(a){var b=[];b.push({ingredientid:a}),j.Search(b).then(function(a){c.IngredientPatterns=a,p(a)},function(a){c.errors=a})}function m(a,b){""===a.name&&b.push("missing name"),a.coverage&&""!==a.coverage||b.push("missing coverage area"),a.purchaseprice&&""!==a.purchaseprice||b.push("missing purchase price")}function n(a){a.coverage&&(a.coverage=Number(a.coverage)),a.purchaseprice&&(a.purchaseprice=Number(a.purchaseprice)),c.Model=a}function o(a){g.Get().then(function(b){if(!a)return void(c.Colors=_.sortBy(b,"name"));var d=b;_.each(d,function(b){var c=_.where(a,{colorid:b.id})[0];c&&(b.ingredientcolorid=c.id,b.checked=!0)}),c.Colors=_.sortBy(d,"name"),q()},function(a){c.errors=a})}function p(a){h.Get().then(function(b){if(!a)return void(c.Patterns=_.sortBy(b,"name"));var d=b;_.each(d,function(b){var c=_.where(a,{patternid:b.id})[0];c&&(b.ingredientpatternid=c.id,b.checked=!0)}),c.Patterns=_.sortBy(d,"name"),r()},function(a){c.errors=a})}function q(){var a=_.where(c.Colors,{checked:!0}).length;return c.ColorsCount=a,a}function r(){var a=_.where(c.Patterns,{checked:!0}).length;return c.PatternsCount=a,a}c.saving=!1,c.Model={name:"",coverage:0,purchaseprice:0},c.PatternsCount=0,c.ColorsCount=0,d.id?(b(d.id),k(d.id),l(d.id)):(o(),p()),c.Cancel=function(){a.back()},c.Save=function(b){c.saving=!0;var g=[];return b.errors=[],m(b,g),g.length>0?(b.errors=g,b.error=g.join(", "),b.error):(b.colors=c.Colors,b.patterns=c.Patterns,b.error=[],b.errors=[],void(d.id&&d.id.length>10?e.Update(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,f.ProcessError(a,b.errors)}):e.Add(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,f.ProcessError(a,b.errors)})))},c.checkColor=function(a){var b=_.where(c.Colors,{id:a})[0];b.checked=!b.checked,q()},c.checkPattern=function(a){var b=_.where(c.Patterns,{id:a})[0];b.checked=!b.checked,r()}}k()}]),angular.module("estimateApp").controller("PatternCtrl",["$rootScope","$state","$scope","$stateParams","Pattern",function(a,b,c,d,e){"use strict";function f(){function b(a){e.Get(a).then(function(a){a[0]&&(c.Model=a[0])},function(a){c.errors=a})}function f(a,b){""===a.name&&b.push("missing name")}c.saving=!1,c.Model={name:""},d.id&&b(d.id),c.Cancel=function(){a.back()},c.Save=function(b){c.saving=!0;var g=[];return b.errors=[],f(b,g),g.length>0?(b.errors=g,b.error=g.join(", "),b.error):(b.error=[],b.errors=[],void(d.id&&d.id.length>10?e.Update(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,b.errors=a,b.error=b.errors.join(", ")}):e.Add(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,b.errors=a,b.error=b.errors.join(", ")})))}}f()}]),angular.module("estimateApp").controller("SystemCtrl",["$rootScope","$state","$scope","$stateParams","$q","System","Reference","Ingredient","SystemDetail","Authorization","Team","SystemTeam",function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";function m(){function b(a){c.IsNew=!1,f.Get(a,{type:"maintain"}).then(function(a){var b=a[0],d=0;b.saleprice&&(isNaN(b.saleprice)||(d=Number(b.saleprice))),b.saleprice=d,c.System=b},function(a){c.errors=a})}function e(a){var b=[];b.push({systemid:a}),i.Search(b).then(function(a){c.SystemIngredients=a,o(a)},function(a){c.errors=a})}function m(a){var b=[];b.push({systemid:a}),l.Search(b).then(function(a){c.Teams=a,p(a)},function(a){c.errors=a})}function n(a,b){a&&""!==a.name||b.push("missing name"),a.saleprice||b.push("missing system price")}function o(a){h.Get().then(function(b){if(!a)return void(c.Ingredients=_.sortBy(b,"name"));var d=b;_.each(d,function(b){var c=_.where(a,{ingredientid:b.id})[0];c&&(b.systemdetailid=c.id,b.checked=!0,b.extra=c.extra,b.primeextra=angular.copy(b.extra),b.factor=c.factor,b.primefactor=angular.copy(b.factor),b.systemdetailversion=c.version)}),c.Ingredients=_.sortBy(d,["checked","name"]),q()},function(a){c.errors=a})}function p(a){k.GetAll().then(function(b){if(!a)return void(c.Teams=_.sortBy(b,"name"));var d=b;_.each(d,function(b){var c=_.where(a,{teamid:b.id})[0];c&&(b.leadteamid=c.id,b.checked=!0,b.leadteamversion=c.version)}),c.Teams=_.sortBy(d,"name"),r()},function(a){c.errors=a})}function q(){var a=_.where(c.Ingredients,{checked:!0}).length;return c.IngredientCount=a,a}function r(){var a=_.where(c.Teams,{checked:!0}).length;return c.TeamCount=a,a}c.saving=!1,c.IsInRoles=function(a){return j.IsInRole(a)},c.System={name:""},c.IsNew=!0,c.TeamCount=0,c.IngredientCount=0,d.id?(b(d.id),e(d.id),m(d.id)):(o(),p()),c.Cancel=function(){a.back()},c.Save=function(b){c.saving=!0;var e=[];return b.errors=[],n(b,e),e.length>0?(b.errors=e,b.error=e.join(", "),void(c.saving=!1)):(b.ingredients=c.Ingredients,b.teams=c.Teams,b.error=[],b.errors=[],void(d.id&&d.id.length>10?f.Update(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,g.ProcessError(a,b.errors)}):f.Add(b).then(function(){c.saving=!1,a.back()},function(a){c.saving=!1,g.ProcessError(a,b.errors)})))},c.checkIngredient=function(a){var b=_.where(c.Ingredients,{id:a})[0];b.checked=!b.checked,q()},c.checkTeam=function(a){var b=_.where(c.Teams,{id:a})[0];b.checked=!b.checked,r()},c.StatusOptions=f.StatusOptions,c.FactorOptions=f.FactorOptions}m()}]),angular.module("estimateApp").controller("TeamCtrl",["$scope","$stateParams","$rootScope","Team","TeamDetail","Reference","Authorization","Utility",function(a,b,c,d,e,f,g,h){"use strict";function i(){function i(b){d.Get(b).then(function(b){b[0]&&(a.Model=b[0],a.canEdit=g.IsOwner(a.Model.addedby),a.Model.members=[],k(b[0].id))},function(b){a.errors=b})}function j(a,b){""===a.name&&b.push("missing name")}function k(b){var c=[];c.push({teamid:b});var d={populate:!0};e.Search(c,d).then(function(b){_.each(b,function(a){a.canDelete=l(a),a.visible=!0}),a.Model.members=b},function(b){a.errors=b})}function l(b){return m?!0:a.Model.id?g.IsOwner(a.Model.addedby)?!0:g.IsOwner(b.addedby)?!0:g.IsOwner(b.personid)?!0:!1:!0}a.saving=!1,a.Model={name:""},a.Model.members=[],a.canEdit=!0;var m=g.IsInRole(["concreteprotector","administrator"]);a.RemoveMember=function(b,c){b.id?b.visible=!1:a.Model.members.splice(c,1)},a.NewMember=function(b){if(a.Model.errors=[],!b||""===b)return void a.Model.errors.push("blank is not a valid email");var c=_.where(a.Model.members,{email:b});if(c.length>0)return void a.Model.errors.push(b+" already exists");if(!h.ValidEmail(b))return void a.Model.errors.push(b+" is not a valid email");var d={email:b,visible:!0,added:!0,canDelete:!0};a.Model.members.push(d),a.email=""},b.id&&i(b.id),a.Cancel=function(){c.back()},a.Save=function(e){a.saving=!0;var g=[];return e.errors=[],j(e,g),g.length>0?(e.errors=g,e.error=g.join(", "),a.saving=!1,e.error):(e.error=[],e.errors=[],e.canEdit=a.canEdit,void(b.id&&b.id.length>10?d.Update(e).then(function(){a.saving=!1,c.back()},function(b){a.saving=!1,f.ProcessError(b,e.errors)}):d.Add(e).then(function(){a.saving=!1,c.back()},function(b){a.saving=!1,f.ProcessError(b,e.errors)})))}}i()}]),angular.module("estimateApp").service("Team",["$q","Service","TeamDetail",function(a,b,c){"use strict";function d(b,d){var e=a.defer(),f=[],g=0,h=_.where(d,{added:!0}),i=[];_.each(h,function(a){var b={email:a.email};i.push(b)});var j={teamid:b,members:i};i.length>0&&(g+=1,f.push(c.Add(j)));var k=_.where(d,{visible:!1});return _.each(k,function(a){g+=1,f.push(c.Remove(a.id))}),g>=0?e.resolve(f):e.promise}var e=this,f={search:"api/v1/team/search",add:"api/v1/team",update:"api/v1/team",ownership:"api/v1/team/ownership",membership:"api/v1/team/membership"};return e.GetMembership=function(){return b.Post({},f.membership)},e.GetOwnership=function(){return b.Post({},f.ownership)},e.Get=function(a){var c={},d=[];return d.push({id:a}),c.criteria=d,b.Post(c,f.search)},e.GetAll=function(){var a={},c=[];return a.criteria=c,b.Post(a,f.search)},e.Add=function(c){var e=a.defer();return b.Post(c,f.add).then(function(b){var f=[];f.push(d(b.id,c.members)),a.all(f).then(function(a){return e.resolve(a)},function(a){return e.reject(a)})},function(a){return e.reject(a)}),e.promise},e.Update=function(c){var e=a.defer();if(c.canEdit)b.Put(c,f.update).then(function(b){var f=[];f.push(d(b.id,c.members)),a.all(f).then(function(a){return e.resolve(a)},function(a){return e.reject(a)})},function(a){return e.reject(a)});else{var g=[];g.push(d(c.id,c.members)),a.all(g).then(function(a){return e.resolve(a)},function(a){return e.reject(a)})}return e.promise},e}]),angular.module("estimateApp").service("TeamDetail",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"teamdetail")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").service("Account",["$q","Config","Authorization","Reference",function(a,b,c,d){"use strict";var e=this;return e.Register=function(b){var e=a.defer(),f={firstname:"",lastname:"",username:"",password:""},g=[];if(b.firstname&&0!==b.firstname.length?f.firstname=b.firstname:g.push("missing first name"),b.lastname&&0!==b.lastname.length?f.lastname=b.lastname:g.push("missing last name"),b.password&&0!==b.password.length?f.password=b.password:g.push("missing password"),b.confirmpassword&&0!==b.confirmpassword.length||g.push("missing confirmation password"),b.confirmpassword&&b.password&&b.confirmpassword!==b.password&&g.push("password and confirmation password do not match"),b.username&&0!==b.username.length?f.username=b.username:g.push("missing email address"),g.length>0)return e.reject(g),e.promise;try{return c.Register(f).then(function(a){e.resolve(a)},function(a){return d.ProcessError(a,g),e.reject(g),e.promise}),e.promise}catch(h){return e.reject(h),e.promise}},e.ExtendToken=function(){var b=a.defer(),e=[];try{return c.ExtendToken().then(function(a){b.resolve(a)},function(a){return d.ProcessError(a,e),b.reject(e),b.promise}),b.promise}catch(f){return b.reject(f),b.promise}},e.Login=function(b){var e=a.defer(),f={username:"",password:""},g=[];return b.username&&0!==b.username.length?f.username=b.username:g.push("missing username"),b.password&&0!==b.password.length?f.password=b.password:g.push("missing password"),g.length>0&&e.reject(g),c.Login(f).then(function(a){e.resolve(a)},function(a){d.ProcessError(a,g),e.reject(g)}),e.promise},e.ChangePassword=function(b){var e=a.defer(),f={newpassword:"",password:""},g=[];return b.password&&0!==b.password.length?f.password=b.password:g.push("missing password"),b.newpassword&&0!==b.newpassword.length?f.newpassword=b.newpassword:g.push("missing new password"),g.length>0&&e.reject(g),c.ChangePassword(f).then(function(a){e.resolve(a)},function(a){d.ProcessError(a,g),e.reject(g)}),e.promise},e.ForgotPassword=function(b){var e=a.defer(),f={username:""},g=[];return b.username&&0!==b.username.length?f.username=b.username:g.push("missing username"),g.length>0&&e.reject(g),c.ForgotPassword(f).then(function(a){e.resolve(a)},function(a){d.ProcessError(a,g),e.reject(g)}),e.promise},e.Feedback=function(b){var e=a.defer(),f=[];return b.feedback&&0!==b.feedback.length||f.push("missing feedback"),f.length>0?e.reject(f):(c.Feedback(b).then(function(a){return e.resolve(a)},function(a){return d.ProcessError(a,f),e.reject(f)}),e.promise)},e}]),angular.module("estimateApp").factory("Authorization",["$q","LocalService","AccessLevels","Config","Service",function(a,b,c,d,e){"use strict";function f(a){var c=JSON.parse(b.Get(d.AuthRoles));return c?_.intersection(c,a).length>0:!0}var g=this,h={login:"api/v1/account/login",register:"api/v1/account/register",feedback:"api/v1/account/feedback",forgotpassword:"api/v1/account/forgotpassword",extendtoken:"/api/v1/account/extend",changepassword:"api/v1/account/changepassword"};return g.CheckToken=function(){var a=b.Get(d.AuthTokenName);if(a){var c=new Date(JSON.parse(b.Get(d.AuthExpiration)));new Date>c&&e.UnsetConfigAuth()}},g.IsInRole=function(a){return f(a)},g.IsAuthorized=function(a){var b=[c.anon];return _.intersection(b,a).length>0?!0:f(a)?g.IsAuthenticated():!1},g.IsOwner=function(a){return a===JSON.parse(b.Get(d.AuthId))},g.IsAuthenticated=function(){return g.CheckToken(),b.Get(d.AuthTokenName)},g.Login=function(b){var c=a.defer();return e.Post(b,h.login).then(function(a){e.SetConfigAuth(a),c.resolve(a)},function(a){c.reject(a)}),c.promise},g.ExtendToken=function(){var b=a.defer();return e.Post({},h.extendtoken).then(function(a){e.SetConfigAuth(a),b.resolve(a)},function(a){b.reject(a)}),b.promise},g.Logout=function(){var b=a.defer();try{e.UnsetConfigAuth(),b.resolve(!0)}catch(c){b.reject(c)}return b.promise},g.Register=function(b){var c=a.defer();return e.Post(b,h.register).then(function(a){e.SetConfigAuth(a),c.resolve(a)},function(a){c.reject(a)}),c.promise},g.ForgotPassword=function(a){return e.Post(a,h.forgotpassword)},g.Feedback=function(a){return e.Post(a,h.feedback)},g.ChangePassword=function(b){var c=a.defer();return e.Post(b,h.changepassword).then(function(a){e.SetConfigAuth(a),c.resolve(a)},function(a){c.reject(a)}),c.promise},g}]),angular.module("estimateApp").factory("Color",["Service","BaseFactory",function(a,b){"use strict";var c=function(){b.constructor.call(this,"color")},d={search:"api/v1/color/search"};return c.GetAll=function(){var b={};return b.criteria=[],a.Post(b,d.search)},c.prototype=Object.create(b.constructor.prototype),c.prototype.constructor=c,new c}]),angular.module("estimateApp").service("Ingredient",["$q","Service","IngredientColor","IngredientPattern",function(a,b,c,d){"use strict";function e(b,d){var e=a.defer(),f=[],g=0;return _.each(d,function(a){g+=1;var d={};a.ingredientcolorid?a.checked===!1&&f.push(c.Remove(a.ingredientcolorid)):a.checked===!0&&(d.ingredientid=b,d.colorid=a.id,f.push(c.Add(d)))}),g===d.length?e.resolve(f):e.promise}function f(b,c){var e=a.defer(),f=[],g=0;return _.each(c,function(a){g+=1;var c={};a.ingredientpatternid?a.checked===!1&&f.push(d.Remove(a.ingredientpatternid)):a.checked===!0&&(c.ingredientid=b,c.patternid=a.id,f.push(d.Add(c)))}),g===c.length?e.resolve(f):e.promise}var g=this,h={search:"api/v1/ingredient/search",add:"api/v1/ingredient",update:"api/v1/ingredient"};
return g.GetAll=function(){var a={};return a.criteria=[],b.Post(a,h.search)},g.Search=function(a){var c={};return c.criteria=a,b.Post(c,h.search)},g.Get=function(a){var c={},d=[];return d.push({id:a}),c.criteria=d,b.Post(c,h.search)},g.Add=function(c){var d=a.defer();return b.Post(c,h.add).then(function(b){var g=[];g.push(e(b.id,c.colors)),g.push(f(b.id,c.patterns)),a.all(g).then(function(a){return d.resolve(a)},function(a){return d.reject(a)})},function(a){return d.reject(a)}),d.promise},g.Update=function(c){var d=a.defer();return b.Put(c,h.update).then(function(b){var g=[];g.push(e(b.id,c.colors)),g.push(f(b.id,c.patterns)),a.all(g).then(function(a){return d.resolve(a)},function(a){return d.reject(a)})},function(a){return d.reject(a)}),d.promise},g}]),angular.module("estimateApp").service("IngredientColor",["Service","BaseFactory",function(a,b){"use strict";var c=function(){b.constructor.call(this,"ingredientcolor")},d={search:"api/v1/ingredientcolor/search"};return c.GetAll=function(){var b={};return b.criteria=[],a.Post(b,d.search)},c.prototype=Object.create(b.constructor.prototype),c.prototype.constructor=c,new c}]),angular.module("estimateApp").service("IngredientPattern",["Service","BaseFactory",function(a,b){"use strict";var c=function(){b.constructor.call(this,"ingredientpattern")},d={search:"api/v1/ingredientpattern/search"};return c.GetAll=function(){var b={};return b.criteria=[],a.Post(b,d.search)},c.prototype=Object.create(b.constructor.prototype),c.prototype.constructor=c,new c}]),angular.module("estimateApp").factory("Pattern",["Service","BaseFactory",function(a,b){"use strict";var c=function(){b.constructor.call(this,"pattern")},d={search:"api/v1/pattern/search"};return c.GetAll=function(){var b={};return b.criteria=[],a.Post(b,d.search)},c.prototype=Object.create(b.constructor.prototype),c.prototype.constructor=c,new c}]),angular.module("estimateApp").service("System",["$q","Service","SystemDetail","SystemTeam",function(a,b,c,d){"use strict";function e(b,d){var e=a.defer(),f=[],g=0;return _.each(d,function(a){g+=1;var d={};if(a.systemdetailid){var e="";(a.extra||a.primeextra)&&a.extra!==a.primeextra&&(e="update"),(a.factor||a.primefactor)&&a.factor!==a.primefactor&&(e="update"),a.checked===!1&&(e="delete"),"update"===e&&(d.id=a.systemdetailid,d.extra=a.extra,d.factor=a.factor,d.version=a.systemdetailversion,f.push(c.Update(d))),"delete"===e&&f.push(c.Remove(a.systemdetailid))}else a.checked===!0&&(d.systemid=b,d.ingredientid=a.id,a.extra&&(d.extra=a.extra),d.factor=a.factor,f.push(c.Add(d)))}),g===d.length?e.resolve(f):e.promise}function f(b,c){var e=a.defer(),f=[],g=0;return _.each(c,function(a){g+=1;var c={};a.leadteamid?a.checked===!1&&f.push(d.Remove(a.leadteamid)):a.checked===!0&&(c.systemid=b,c.teamid=a.id,f.push(d.Add(c)))}),g===c.length?e.resolve(f):e.promise}var g=this,h={search:"api/v1/system/search",add:"api/v1/system",update:"api/v1/system"};return g.GetSystems=function(a,c){var d={},e=[];return a&&e.push({populate:"true"}),d.criteria=e,d.searchType=c,b.Post(d,h.search)},g.GetSystem=function(a,c,d){var e={},f=[];return f.push({id:a}),c&&f.push({populate:"true"}),e.criteria=f,e.searchType=d,b.Post(e,h.search)},g.GetAll=function(a){var c={};return c.searchType=a,c.criteria=[],b.Post(c,h.search)},g.Get=function(a,c){var d={},e=[];return e.push({id:a}),d.criteria=e,d.searchType=c,b.Post(d,h.search)},g.Add=function(c){var d=a.defer();return b.Post(c,h.add).then(function(b){var g=[];g.push(e(b.id,c.ingredients)),g.push(f(b.id,c.teams)),a.all(g).then(function(a){return d.resolve(a)},function(a){return d.reject(a)})},function(a){return d.reject(a)}),d.promise},g.Update=function(c){var d=a.defer();return b.Put(c,h.update).then(function(b){var g=[];g.push(e(b.id,c.ingredients)),g.push(f(b.id,c.teams)),a.all(g).then(function(a){return d.resolve(a)},function(a){return d.reject(a)})},function(a){return d.reject(a)}),d.promise},g.StatusOptions=[{key:"1",statusDisplay:"active"},{key:"0",statusDisplay:"inactive"}],g.FactorOptions=[{key:"1",display:"1"},{key:"2",display:"2"},{key:"3",display:"3"},{key:"4",display:"4"},{key:"5",display:"5"},{key:"6",display:"6"},{key:"7",display:"7"},{key:"8",display:"8"},{key:"9",display:"9"},{key:"10",display:"10"}],g}]),angular.module("estimateApp").service("SystemDetail",["Service","BaseFactory",function(a,b){"use strict";var c=function(){b.constructor.call(this,"systemdetail")},d={search:"api/v1/systemdetail/search"};return c.GetAll=function(){var b={};return b.criteria=[],a.Post(b,d.search)},c.prototype=Object.create(b.constructor.prototype),c.prototype.constructor=c,new c}]),angular.module("estimateApp").service("SystemTeam",["Service","BaseFactory",function(a,b){"use strict";var c=function(){b.constructor.call(this,"teamsystem")},d={search:"api/v1/teamsystem/search",add:"api/v1/teamsystem",update:"api/v1/teamsystem",remove:"api/v1/teamsystem"};return c.GetAll=function(){var b={};return b.criteria=[],a.Post(b,d.search)},c.prototype=Object.create(b.constructor.prototype),c.prototype.constructor=c,new c}]),angular.module("estimateApp").controller("EstimatesCtrl",["$scope","$stateParams","$state","Project",function(a,b,c,d){"use strict";function e(){a.Estimates=[];var e=!1,f=!1;b.id>0&&(f=b.id),""!==b.time&&(e=b.time),d.GetProjectDetails(e,f).then(function(b){a.Estimate=b},function(b){a.errors=b}),a.Edit=function(){c.go("index.project",{id:b.id})}}e()}]),angular.module("estimateApp").controller("NewLeadCtrl",["$scope","$stateParams","$state","$rootScope","Lead","Authorization","Reference","System","SystemDetail","Ingredient","$window","Team",function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";function m(){function b(){var b=_.where(a.Teams,{checked:!0}).length;return a.TeamCount=b,b}function c(b){if(a.System={},b){var c=_.where(a.Systems,{id:b})[0];c.saleprice=Number(c.saleprice),a.System=c,j()}}function i(b){a.System={},b.saleprice=Number(b.saleprice),a.System=b,j()}function j(){var b=a.LeadSystem.length||0,c=a.LeadSystem.width||0,d=(b*c).toFixed(2),e=0;_.each(a.System.ingredients,function(a){var b=(d/a.coverage*a.factor).toFixed(2),c=b*a.purchaseprice;a.contractorprice=c,a.amount=b,e+=c});var f=a.System.saleprice*d;a.System.coverage=d,a.System.price=f.toFixed(2),a.System.contractortotalprice=e.toFixed(2)}function m(b,c){if(b.firstname||b.lastname||b.company||c.push("first name, last name or company required"),b.hasaddress=!1,b.hasphone=!1,b.hasdetail=!1,b.address1&&(b.hasaddress=!0),b.address2&&(b.hasaddress=!0),b.city&&(b.hasaddress=!0),b.state&&(b.hasaddress=!0),b.zip&&(b.hasaddress=!0),b.addresstype&&(b.hasaddress=!0),b.hasaddress){b.addresses=[];var d={address1:b.address1,address2:b.address2,city:b.city,state:b.state,zip:b.zip,addresstype:b.addresstype,primary:!0};b.addresses.push(d),b.address1||(b.address1=""),b.city||(b.city=""),b.state||(b.state="OH"),b.zip||(b.zip=""),b.addresstype||(b.addresstype="home")}if(b.number&&(b.hasphone=!0),b.phonetype&&(b.hasphone=!0),b.hasphone){b.phones=[];var e={number:b.number,phonetype:b.phonetype,primary:!0};b.phones.push(e),b.number||(b.number=""),b.phonetype||(b.phonetype="home")}b.email&&(b.hasdetail=!0),b.besttimetocall&&(b.hasdetail=!0),b.hearaboutus&&(b.hasdetail=!0),b.howcanwehelp&&(b.hasdetail=!0),b.Teams=a.Teams,b.Systems=a.LeadSystems,b.note&&b.note.length>490&&c.push("note is too long")}a.LeadSystem={},a.LeadSystems=[],a.Model={},a.System={},a.saving=!1,a.IsInRoles=function(a){return f.IsInRole(a)};var n={type:"use",populate:["systemdetail","ingredient"]};h.GetAll(n).then(function(b){a.Systems=b},function(b){a.errors=b}),g.States("us").then(function(b){a.States=b},function(b){a.errors=b}),g.PhoneTypes().then(function(b){a.PhoneTypes=b},function(b){a.errors=b}),g.AddressTypes().then(function(b){a.AddressTypes=b},function(b){a.errors=b});var o=f.IsInRole(["concreteprotector","subscriber","administrator"]);o&&l.GetAll().then(function(c){a.Teams=_.sortBy(c,"name"),b()},function(b){a.errors=b}),a.checkTeam=function(c){var d=_.where(a.Teams,{id:c})[0];d.checked=!d.checked,b()},a.BestTimeToCalLOptions=e.BestTimeToCalLOptions,a.AddSystem=function(b){if(a.Model.errors=[],!b.areaname)return void a.Model.errors.push("area name required");b.length||(b.length=0),b.width||(b.width=0),b.systemid?(j(),b.System=angular.copy(a.System)):(b.systemid=a.Systems[0].id,j(),b.System=angular.copy(a.Systems[0]));var c=angular.copy(b);a.LeadSystems.push(c),a.LeadSystem={},b={},a.System={},a.showIngredients=!1},a.UpdateSystem=function(b){return a.Model.errors=[],b.areaname?(b.System=angular.copy(a.System),a.LeadSystems[a.LeadSystemPrimeIndex]=b,a.LeadSystem={},a.System={},a.LeadSystemPrime={},a.LeadSystemEdit=!1,void(a.showIngredients=!1)):void a.Model.errors.push("area name required")},a.RemoveSystem=function(b,c){function d(d){1===d&&(b.id?b.visible=!1:a.LeadSystems.splice(c,1),a.LeadSystem={},a.System={},a.LeadSystemPrime={},a.LeadSystemEdit=!1,a.showIngredients=!1)}var e="Are you absolutely sure you want to remove this area:  "+b.areaname+"?";if(navigator&&navigator.notification)navigator.notification.confirm(e,d,"Delete",["Yes","No"]);else{var f=k.confirm(e);f&&d(1)}},a.EditSystem=function(b,c){a.LeadSystem={},a.System={},a.LeadSystemPrime=b,a.LeadSystemPrimeIndex=c,a.LeadSystem=angular.copy(b),i(a.LeadSystem.System),a.LeadSystemEdit=!0,a.showIngredients=!1},a.CancelUpdateSystem=function(){a.LeadSystemPrime={},a.LeadSystem={},a.System={},a.LeadSystemEdit=!1,a.showIngredients=!1},a.SystemChange=function(a){c(a)},a.AreaChanged=function(){j()},a.SaveLead=function(b){a.saving=!0;{var c=[];this.leadform}return b.Errors=[],m(b,c),c.length>0?(b.errors=c,b.error=c.join(", "),a.saving=!1,b.error):(b.error=[],b.errors=[],void e.Add(b).then(function(){a.saving=!1,d.back()},function(c){a.saving=!1,b.errors=c,b.error=b.errors.join(", ")}))},a.Cancel=function(){a.saving=!1,d.back()}}m()}]),angular.module("estimateApp").controller("LeadCtrl",["$scope","$stateParams","$state","$rootScope","$q","Lead","Authorization","Reference","Address","Phone","$window","Team","LeadTeam","LeadDetail","Project","Person",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){"use strict";function q(){function c(b){a.Model=b,a.ModelPrime={},a.editingLead=!1}function k(b){a.Addresses=b,a.editingAddress=!1}function q(b){a.Phones=b,a.editingPhone=!1}function r(b){a.Estimates=b}function s(b){a.Current=b}function t(b){a.Complete=b}function u(b){a.editingTeams=!1;var c=[];c.push({personid:b}),m.Search(c).then(function(b){a.Teams=b,v(b)},function(b){h.ProcessError(b,a.errors)})}function v(b){l.GetAll().then(function(c){if(a.CurrentTeams=[],!b)return void(a.Teams=_.sortBy(c,"name"));var d=c;_.each(d,function(c){var d=_.where(b,{teamid:c.id})[0];d&&(c.leadteamid=d.id,c.checked=!0,c.leadteamversion=d.version,a.CurrentTeams.push(c))}),a.Teams=_.sortBy(d,"name"),a.CurrentTeams=_.sortBy(a.CurrentTeams,"name"),a.TeamCount=a.CurrentTeams.length},function(b){h.ProcessError(b,a.errors)})}function w(a,b){a.person.firstname||a.person.lastname||a.person.company||b.push("first name, last name or company required"),a.hasdetail=!1,a.detail.email&&(a.hasdetail=!0),a.detail.besttimetocall&&(a.hasdetail=!0),a.detail.hearaboutus&&(a.hasdetail=!0),a.detail.howcanwehelp&&(a.hasdetail=!0)}function x(a){a.number||(a.number=""),a.type||(a.type="home")}function y(a){a.address1||(a.address1=""),a.city||(a.city=""),a.state||(a.state="OH"),a.zip||(a.zip=""),a.type||(a.type="home")}a.moreThanAUser=!1,a.DisableAddLead=!1,g.IsInRole(["concreteprotector","subscriber","administrator"])&&(a.moreThanAUser=!0,a.DisableAddLead=!0),a.Model={},a.Addresses=[],a.Phones=[];var z=[{personid:b.id}],A={searchType:"use",populate:!0,status:status},B=[];b.id&&""!==b.id&&(a.leadid=b.id,B=[],B.push(f.Get(b.id,A)),B.push(i.Search(z)),B.push(j.Search(z)),B.push(o.Search([{leadid:b.id},{time:"estimate"}])),B.push(o.Search([{leadid:b.id},{time:"current"}])),B.push(o.Search([{leadid:b.id},{time:"complete"}])),e.all(B).then(function(d){c(d[0][0]),k(d[1]),q(d[2]),r(d[3]),s(d[4]),t(d[5]),a.moreThanAUser===!0&&u(b.id)},function(b){h.ProcessError(b,a.errors)})),a.IsInRoles=function(a){return g.IsInRole(a)},h.States("us").then(function(b){a.States=b},function(b){h.ProcessError(b,a.errors)}),h.PhoneTypes().then(function(b){a.PhoneTypes=b},function(b){h.ProcessError(b,a.errors)}),h.AddressTypes().then(function(b){a.AddressTypes=b},function(b){h.ProcessError(b,a.errors)}),a.checkTeam=function(b){var c=_.where(a.Teams,{id:b})[0];c.checked=!c.checked},a.StatusOptions=f.Statuses,a.BestTimeToCalLOptions=f.BestTimeToCalLOptions,a.EditLead=function(){a.ModelPrime=angular.copy(a.Model),a.editingLead=!0},a.CancelEditLead=function(){a.Model=angular.copy(a.ModelPrime),a.editingLead=!1},a.SaveLead=function(d){var g=[];if(d.Errors=[],w(d,g),g.length>0)return d.errors=g,d.error=g.join(", "),d.error;if(d.error=[],d.errors=[],B=[],B.push(p.Update(d.person)),B.push(f.Update(d)),d.detail.id)B.push(n.Update(d.detail));else if(d.hasdetail){var i={leadid:d.id,email:d.detail.email,besttimetocall:d.detail.besttimetocall,hearaboutus:d.detail.hearaboutus,howcanwehelp:d.detail.howcanwehelp};B.push(n.Add(i))}e.all(B).then(function(){f.Get(b.id,A).then(function(a){c(a[0])},function(b){h.ProcessError(b,a.errors)})},function(b){h.ProcessError(b,a.errors)})},a.EditPhone=function(b,c){a.PhoneModelIndex=c,a.PhoneModelPrime=angular.copy(b),a.PhoneModel=b,a.editingPhone=!0},a.NewPhone=function(){a.PhoneModel={},a.editingPhone=!0},a.CancelEditPhone=function(){a.Phones[a.PhoneModelIndex]=angular.copy(a.PhoneModelPrime),a.PhoneModelPrime={},a.PhoneModel={},a.editingPhone=!1},a.SavePhone=function(){var d=a.PhoneModel,g=[];if(d.Errors=[],x(d,g),g.length>0)return d.errors=g,d.error=g.join(", "),d.error;if(d.error=[],d.errors=[],B=[],d.id)B.push(j.Update(d));else{var i={personid:b.id,number:d.number,type:d.type,primary:d.primary};B.push(j.Add(i))}e.all(B).then(function(){B=[],B.push(f.Get(b.id,A)),B.push(j.Search(z)),e.all(B).then(function(a){c(a[0][0]),q(a[1])},function(b){h.ProcessError(b,a.errors)})},function(b){h.ProcessError(b,a.errors)})},a.EditAddress=function(b,c){a.AddressModelIndex=c,a.AddressModelPrime=angular.copy(b),a.AddressModel=b,a.editingAddress=!0},a.NewAddress=function(){a.AddressModel={},a.editingAddress=!0},a.CancelEditAddress=function(){a.Addresses[a.AddressModelIndex]=angular.copy(a.AddressModelPrime),a.AddressModelPrime={},a.AddressModel={},a.editingAddress=!1},a.SaveAddress=function(){var c=a.AddressModel,d=[];if(c.Errors=[],y(c,d),d.length>0)return c.errors=d,c.error=d.join(", "),c.error;if(c.error=[],c.errors=[],B=[],c.id)B.push(i.Update(c));else{var f={personid:b.id,address1:c.address1,address2:c.address2,city:c.city,state:c.state,zip:c.zip,addresstype:c.addresstype,primary:c.primary};B.push(i.Add(f))}e.all(B).then(function(){i.Search(z).then(function(a){k(a)},function(b){h.ProcessError(b,a.errors)})},function(b){h.ProcessError(b,a.errors)})},a.Cancel=function(){d.back()},a.SaveTeams=function(){var c=[];_.each(a.Teams,function(a){var d={};a.leadteamid?a.checked===!1&&c.push(m.Remove(a.leadteamid)):a.checked===!0&&(d.personid=b.id,d.teamid=a.id,c.push(m.Add(d)))}),e.all(c).then(function(){u(b.id)},function(b){h.ProcessError(b,a.errors)})},a.CancelEditTeams=function(){a.Teams=angular.copy(a.TeamsPrime),a.editingTeams=!1},a.EditTeams=function(){a.TeamsPrime=angular.copy(a.Teams),a.editingTeams=!0}}q()}]),angular.module("estimateApp").controller("LeadsCtrl",["$scope","$stateParams","$state","$rootScope","Lead","Config","Authorization",function(a,b,c,d,e,f,g){"use strict";function h(){a.moreThanAUser=!1,a.DisableAddLead=!1,g.IsInRole(["concreteprotector","subscriber","administrator"])&&(a.moreThanAUser=!0);var h="1";b.status&&(h=b.status),"1"===h?d.$broadcast(f.SetTitleEvent,"Active Leads"):"0"===h&&d.$broadcast(f.SetTitleEvent,"Inactive Leads");var i={searchType:"use",populate:!0,status:h};a.Leads=[],e.GetAll(i).then(function(b){a.moreThanAUser===!1&&b.length>9&&(a.DisableAddLead=!0),_.each(b,function(b){b.phone||(b.phone={number:""}),a.Leads.push({id:b.id,hasNames:b.person.firstname.length>0||b.person.lastname.length>0,firstname:b.person.firstname,lastname:b.person.lastname,phone:b.phone.number||"",company:b.person.company})})},function(b){a.errors=b}),a.Edit=function(){c.go("index.lead",{id:b.id})},a["goto"]=function(a){c.go("index.lead",{id:a})}}h()}]),angular.module("estimateApp").controller("ProjectCtrl",["$window","$scope","$stateParams","$q","$rootScope","Lead","Project","ProjectDetail","Config","System","ProjectDetailStyle","Storage","Person","Reference","Note","Address","$cordovaCamera","$filter",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){"use strict";function s(){function s(a){b.Lead=a}function t(a){var b=d.defer();return a.id&&36===a.id.length?b.resolve(a):u(a).then(function(a){return b.resolve(a)},function(a){b.reject(a)}),b.promise}function u(a){var c=d.defer();return a.id&&36===a.id.length?g.Update(a).then(function(a){return b.isNew=!1,b.projectid=a.id,b.Model=a,a.designconsult&&(b.Model.designconsult=new Date(a.designconsult)),a.install&&(b.Model.install=new Date(a.install)),a.completed&&(b.Model.completed=new Date(a.completed)),c.resolve(a)},function(a){return c.reject(a)}):g.Add(a).then(function(a){return b.isNew=!1,b.projectid=a.id,b.Model=a,a.designconsult&&(b.Model.designconsult=new Date(a.designconsult)),a.install&&(b.Model.install=new Date(a.install)),a.completed&&(b.Model.completed=new Date(a.completed)),c.resolve(a)},function(a){return c.reject(a)}),c.promise}function v(a){var c=d.defer();return a.id&&36===a.id.length?h.Update(a).then(function(a){return b.LeadSystem=a,b.saving=!1,c.resolve(a)},function(a){return b.saving=!1,c.reject(a)}):t(b.Model).then(function(d){a.projectid=d.id,a.saleprice=b.System.saleprice,h.Add(a).then(function(a){return b.saving=!1,b.LeadSystem=a,c.resolve(a)},function(a){return b.saving=!1,c.reject(a)})},function(a){return c.reject(a)}),c.promise}function w(){g.Search([{id:b.projectid}]).then(function(a){y(a[0])},function(a){b.LeadSystem.errors.push(a)})}function x(a){b.Notes=a}function y(a){a.designconsult&&(a.designconsult=new Date(a.designconsult),a.designconsult=r("date")(a.designconsult,"MM/dd/yyyy")),a.install&&(a.install=new Date(a.install),a.install=r("date")(a.install,"MM/dd/yyyy")),a.completed&&(a.completed=new Date(a.completed),a.completed=r("date")(a.completed,"MM/dd/yyyy")),b.Model=a,b.ModelPrime={},D(),b.manageSystem=!1,b.showIngredients=!1,b.showAreaPrice=!1,x(a.notes)}function z(a){var c=!1;a.id||(c=!0,a.projectid=b.projectid);var d=b.System,e=b.LeadSystemPrime,f=!1,g=[],h=[],i=[];a.systemid!==e.systemid&&(f=!0,e.styles&&e.styles.length>0&&_.each(e.styles,function(a){i.push(a.id)})),a.systemid=d.id,a.saleprice=j.saleprice,a.area=d.coverage,a.saleprice=d.saleprice,v(a).then(function(a){_.each(d.ingredients,function(b){A(f,b,a,h,g)}),B(h,i,g),b.saving=!1},function(a){b.saving=!1,n.ProcessError(a,b.LeadSystem.errors)})}function A(a,b,c,d,e){var f={};a?(b.style&&(f=b.style),f.projectdetailid=c.id,f.ingredientid=b.id,f.purchaseprice=b.purchaseprice,d.push(f)):b.style.id?(f=b.style,f.ingredientid=b.id,e.push(f)):(b.style&&(f=b.style),f.projectdetailid=c.id,f.ingredientid=b.id,f.purchaseprice=b.purchaseprice,d.push(f))}function B(a,c,e){var f=(d.promise,[]);_.each(c,function(a){f.push(k.Remove(a))}),_.each(a,function(a){f.push(k.Add(a))}),_.each(e,function(a){f.push(k.Update(a))}),d.all(f).then(function(){w()},function(a){b.LeadSystem.errors.push(a)})}function C(a){if(b.System={},a){var c=_.where(b.Systems,{id:a})[0];c.saleprice=Number(c.saleprice),b.System=c,F()}}function D(){_.each(b.Model.details,function(a){a.System=_.where(b.Systems,{id:a.systemid})[0],a.System&&(a.System.saleprice=Number(a.saleprice))}),b.Model.saleprice&&(b.Sytem.saleprice=b.Model.saleprice),b.LeadSystems=b.Model.details}function E(a){b.System={},a&&(_.each(a.ingredients,function(a){_.where(b.LeadSystem.styles,{ingredientid:a.id})[0];a.style=_.where(b.LeadSystem.styles,{ingredientid:a.id})[0]}),b.System=a,F())}function F(){var a=b.LeadSystem.arealength||0,c=b.LeadSystem.areawidth||0,d=(a*c).toFixed(2),e=0;_.each(b.System.ingredients,function(a){var b=(d/a.coverage*a.factor).toFixed(2),c=b*a.purchaseprice;a.contractorprice=c,a.amount=b,e+=c});var f=b.System.saleprice*d;b.System.coverage=d,b.System.price=f.toFixed(2),b.System.contractortotalprice=e.toFixed(2)}function G(a){var b=[],c=d.defer(),e=_.where(a,{type:"areaimage"});return _.each(e,function(a){b.push(l.GetFileImageString(a.id))}),d.all(b).then(function(a){return _.each(e,function(b,c){b.data=a[c]}),c.resolve(e)},function(a){return c.reject(a)}),c.promise}function H(){0===b.AreaImages.length&&l.Search([{fid:b.projectid}]).then(function(a){G(a).then(function(a){b.AreaImages=a},function(a){n.ProcessError(a,b.errors)})},function(a){n.ProcessError(a,b.errors)})}function I(a){b.NewPicture=!0,b.AreaImage=a}b.projectid=c.projectid,b.leadid=c.leadid,b.AreaImages=[],b.AreaImage={},b.Signature={},b.showIngredients=!0,b.saving=!1,b.isNew=!0,b.projectid&&36===b.projectid.length&&(b.isNew=!1),b.isNew===!0&&e.$broadcast(i.SetTitleEvent,"New Estimate");var J=[],K={searchType:"use",populate:!0},L={type:"use",populate:["systemdetail","ingredient"]};J.push(f.Get(b.leadid,K)),J.push(j.GetAll(L));var M=[{personid:b.leadid}];J.push(p.Search(M)),b.isNew===!1&&J.push(g.Search([{id:b.projectid}])),d.all(J).then(function(a){s(a[0][0]),b.Systems=a[1],b.Addresses=a[2],y(a.length>3?a[3][0]:{leadid:b.Lead.id})},function(a){b.errors=a}),b.Cancel=function(){b.saving=!1,e.back()},b.EditLead=function(){b.ModelPrime=angular.copy(b.Model),b.LeadPrime=angular.copy(b.Lead),b.Model.install=r("date")(b.Model.install,"MM/dd/yyyy"),b.Model.completed=r("date")(b.Model.completed,"MM/dd/yyyy"),b.Model.designconsult=r("date")(b.Model.designconsult,"MM/dd/yyyy"),b.manageLead=!0},b.CancelLeadUpdate=function(){b.Model=angular.copy(b.ModelPrime),b.Lead=angular.copy(b.LeadPrime),b.manageLead=!1},b.SaveLead=function(a){b.Model.errors=[],b.saving=!0;var c=!1;c===!1&&b.LeadPrime.person.firstname!==b.Lead.person.firstname&&(c=!0),c===!1&&b.LeadPrime.person.lastname!==b.Lead.person.lastname&&(c=!0),c===!1&&b.LeadPrime.person.company!==b.Lead.person.company&&(c=!0);var e=[];e.push(u(a)),e.push(m.Update(b.Lead.person)),d.all(e).then(function(a){e.length>0&&(b.saving=!1,b.Lead.person=a[1])},function(a){b.saving=!1,b.Model.errors.push(a)}),b.manageLead=!1},b.NewSystem=function(){b.LeadSystemPrime={},b.LeadSystem={},b.System={},E(b.LeadSystem.System),b.manageSystem=!0},b.CancelUpdateSystem=function(){b.saving=!1,b.LeadSystemPrime={},b.LeadSystem={},b.System={},b.manageSystem=!1,b.showIngredients=!1,b.showAreaPrice=!1},b.SaveSystem=function(a){return b.LeadSystem.errors=[],b.saving=!0,a.name?(a.length||(a.length=0),a.width||(a.width=0),a.systemid||(a.systemid=b.Systems[0].id,F(),a.System=angular.copy(b.Systems[0])),void z(a)):(b.LeadSystem.errors.push("area name required"),void(b.saving=!1))},b.UpdateSystem=function(a){return b.LeadSystem.errors=[],a.areaname?(a.System=angular.copy(b.System),b.LeadSystems[b.LeadSystemPrimeIndex]=a,b.LeadSystem={},b.System={},b.LeadSystemPrime={},b.manageSystem=!1,b.showIngredients=!1,void(b.showAreaPrice=!1)):void b.LeadSystem.errors.push("area name required")},b.RemoveSystem=function(c,d){function e(a){1===a&&(c.id?c.visible=!1:b.LeadSystems.splice(d,1),b.LeadSystem={},b.System={},b.LeadSystemPrime={},b.manageSystem=!1,b.showIngredients=!1,b.showAreaPrice=!1)}var f="Are you absolutely sure you want to remove this area:  "+c.areaname+"?";if(navigator&&navigator.notification)navigator.notification.confirm(f,e,"Delete Area",["Yes","No"]);else{var g=a.confirm(f);g&&e(1)}},b.EditSystem=function(a,c){b.LeadSystem={},b.System={},b.LeadSystemPrime=a,b.LeadSystemPrimeIndex=c,b.LeadSystem=angular.copy(a),E(b.LeadSystem.System),b.manageSystem=!0},b.SystemChange=function(a){C(a)},b.AreaChanged=function(){F()},b.RemoveAreaImage=function(c,d){function e(e){1===e&&c.id&&l.Remove(c.id).then(function(){b.AreaImages.splice(d,1)},function(b){a.alert(b)})}if(navigator&&navigator.notification)navigator.notification.confirm("Are you absolutely sure you want to remove this image?",e,"Delete Image",["Yes","No"]);else{var f=a.confirm("Are you absolutely sure you want to remove this image?");f&&e(1)}},b.TakePicture=function(){if(b.AreaImage={},b.AreaImage.errors=[],navigator&&navigator.camera){var a={quality:50,destinationType:Camera.DestinationType.DATA_URL,encodingType:Camera.EncodingType.PNG,correctOrientation:!0,targetWidth:800,targetHeight:600};q.getPicture(a).then(function(a){var b={data:a};I(b)},function(a){n.ProcessError(a,b.AreaImage.errors)})}},b.$watch("showImages",function(a,b){a===!0&&void 0===b&&H()}),b.SaveAreaImage=function(){if(b.saving=!0,b.AreaImage.errors=[],b.projectid){var a={};a.type="areaimage",a.data=b.AreaImage.data,a.fid=b.projectid,l.Add(a).then(function(a){b.saving=!1,a.data=b.AreaImage.data,b.AreaImage={},b.AreaImages.push(a)},function(a){b.saving=!1,b.AreaImage.errors.push(a)})}else t(b.Model).then(function(a){var c={};c.type="areaimage",c.data=b.AreaImage.data,c.fid=a.id,l.Add(c).then(function(a){b.saving=!1,a.data=b.AreaImage.data,b.AreaImages.push(a),b.AreaImage={}},function(a){b.saving=!1,b.AreaImage.errors.push(a)})},function(a){b.saving=!1,b.AreaImage.errors.push(a)});b.NewPicture=!1},b.CancelSaveAreaImage=function(){b.saving=!1,b.NewPicture=!1,b.AreaImage={}},b.SaveSignature=function(a){if(b.saving=!0,b.Signature.errors=[],!a.data||0===a.data.length)return void b.Signature.errors.push("signature missing");if(b.projectid)if(b.Signature.id&&36===b.Signature.id.length)l.Update(a).then(function(c){b.saving=!1,c.datadisplay="data:"+a.data,c.data=null,b.Signature=c,b.editSignature=!1},function(a){b.saving=!1,b.Signature.errors.push(a)});else{var c={};c.type="signature",c.data=a.data,c.fid=b.projectid,c.filename="signature",l.Add(c).then(function(c){b.saving=!1,c.data=null,c.datadisplay="data:"+a.data,b.Signature=c,b.editSignature=!1},function(a){b.saving=!1,b.Signature.errors.push(a)})}else t(b.Model).then(function(c){var d={};d.type="signature",d.data=a.data,d.fid=c.id,d.filename="signature",l.Add(d).then(function(c){b.saving=!1,c.data=null,c.datadisplay="data:"+a.data,b.Signature=c,b.editSignature=!1},function(a){b.saving=!1,b.Signature.errors.push(a)})},function(a){b.saving=!1,b.Signature.errors.push(a)})},b.CancelSaveSignature=function(){b.saving=!1,b.Signature=angular.copy(b.SignaturePrime),b.editSignature=!1},b.EditSignature=function(){b.saving=!1,b.SignaturePrime=angular.copy(b.Signature),b.editSignature=!0},b.ProjectStatuses=n.ProjectStatuses,b.SaveNote=function(a){return b.saving=!0,a&&a.note?(b.saving=!1,void t(b.Model).then(function(c){var d={fid:c.id,body:a.note};o.Add(d).then(function(){b.saving=!1,b.saving=!1,o.Search([{fid:c.id}]).then(function(a){x(a),b.NewNote={}})},function(a){b.saving=!1,n.ProcessError(a,b.errors)})},function(a){b.saving=!1,n.ProcessError(a,b.errors)})):void(b.saving=!1)}}s()}]),angular.module("estimateApp").controller("ProjectsCtrl",["$scope","$stateParams","$rootScope","Project","Config","Utility",function(a,b,c,d,e){"use strict";function f(){a.Projects=[],a.UpperTime="",a.LowerTime="",a.IdParam=!1,a.SearchPlaceholder="";var f=1,g="Active",h="current",i="Estimates";b.status.length>-1&&(f=parseInt(b.status),0===f&&(g="Inactive")),b.time&&(h=b.time,"current"===h&&(i="Current Projects",a.datename="Install Date"),"complete"===h&&(i="Complete Projects",a.datename="Complete Date"),"estimate"===h&&(i="Estimates",a.datename="Date Added"));var j=g+" "+i;c.$broadcast(e.SetTitleEvent,j),a.SearchPlaceholder="search "+j.toLocaleLowerCase();var k={searchType:"use",populate:!0},l=[{status:f},{time:h}];d.Search(l,k).then(function(b){_.each(b,function(b){var c={};c.firstname=b.person.firstname,c.lastname=b.person.lastname,c.company=b.person.company,c.area=b.totalarea,c.cost=b.totalcost,c.leadid=b.leadid,c.date="",c.hasdate=!1,c.hasnames=b.person.firstname.length>0||b.person.lastname.length>0,"estimate"===h&&(c.hasdate=b.added.length>0,c.date=new Date(b.added)),"current"===h&&(c.hasdate=b.install,c.date=new Date(b.install)),"complete"===h&&(c.hasdate=b.completed,c.date=new Date(b.completed)),c.id=b.id,a.Projects.push(c)})},function(b){a.errors=b})}f()}]),angular.module("estimateApp").service("Lead",["$q","Reference","Service","Person","Address","Phone","Project","ProjectDetail","LeadDetail","LeadTeam","Note","ProjectDetailStyle",function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";function m(b,d,e){var f=a.defer(),j=[],m={personid:d.id};if(j.push(c.Post(m,r.add)),b.hasphone&&j.push(o(d.id,b.phones)),b.hasdetail===!0){var n={leadid:d.id,email:b.email,besttimetocall:b.besttimetocall,hearaboutus:b.hearaboutus,howcanwehelp:b.howcanwehelp};j.push(i.Add(n))}return b.Teams&&b.Teams.length>0&&j.push(p(d.id,b.Teams)),a.all(j).then(function(c){if(b.Systems&&b.Systems.length>0){var i={leadid:d.id,projectstatus:"estimate"};e&&(i.addressid=e.id),b.designconsultdate&&(i.designconsultdate=b.designconsultdate),g.Add(i).then(function(c){var d=[];if(_.each(b.Systems,function(a){var b={projectid:c.id,systemid:a.System.id,saleprice:a.System.saleprice,area:a.System.coverage,name:a.areaname,arealength:a.length,areawidth:a.width};d.push(h.Add(b))}),b.note){var e={fid:c.id,body:b.note};d.push(k.Add(e))}a.all(d).then(function(c){var d=0,e=[];_.each(b.Systems,function(a){var b=c[d],f=a.System.ingredients;_.each(f,function(a){var c={ingredientid:a.id,projectdetailid:b.id,colorid:a.selectedColor,patternid:a.selectedPattern};e.push(l.Add(c))}),d+=1}),a.all(e).then(function(a){return f.resolve(a)},function(a){return f.reject(a)})},function(a){return f.reject(a)})},function(a){return f.reject(a)})}else f.resolve(c)},function(a){return f.reject(a)}),f.promise}function n(a,b){var c={};return c.personid=a,c.address1=b.address1,c.address2=b.address2,c.city=b.city,c.state=b.state,c.zip=b.zip,c.type=b.type,c.primary=b.primary,c}function o(b,c){var d=a.defer(),e=[],g=0;return _.each(c,function(a){g+=1;var c={};if(a.personid){var d="";a.extra&&a.prime&&a.extra!==a.prime&&(d="update"),a.checked===!1&&(d="delete"),"update"===d&&(c.id=a.addressid,c.version=a.phoneversion,c.number=a.number,c.type=a.type,c.primary=a.primary,e.push(f.Update(c))),"delete"===d&&e.push(f.Remove(a.addressid))}else c.personid=b,c.number=a.number,c.type=a.type,c.primary=a.primary,e.push(f.Add(c))}),g===c.length?d.resolve(e):d.promise}function p(b,c){var d=a.defer(),e=[],f=0;return _.each(c,function(a){f+=1;var c={};a.leadteamid?a.checked===!1&&e.push(j.Remove(a.leadteamid)):a.checked===!0&&(c.personid=b,c.teamid=a.id,e.push(j.Add(c)))}),f===c.length?d.resolve(e):d.promise}var q=this,r={search:"api/v1/lead/search",add:"api/v1/lead",update:"api/v1/lead"};return q.Statuses=b.Statuses,q.BestTimeToCalLOptions=[{key:"Morning",time:"Morning"},{key:"Afternoon",time:"Afternoon"},{key:"Evening",time:"Evening"}],q.GetAll=function(a){var b={},d=[],e={searchType:"use",populate:!0};return a&&(e=a),b.hints=e,b.criteria=d,c.Post(b,r.search)},q.Get=function(a,b){var d={},e=[],f={searchType:"use",populate:!0};return b&&(f=b),e.push({id:a}),d.hints=f,d.criteria=e,c.Post(d,r.search)},q.Add=function(b){var c=a.defer(),f={firstname:b.firstname,lastname:b.lastname,company:b.company};return d.Add(f).then(function(a){if(b.hasaddress===!0){var d=n(a.id,b.addresses[0]);e.Add(d).then(function(d){m(b,a,d).then(function(a){return c.resolve(a)},function(a){return c.reject(a)})},function(a){return c.reject(a)})}else m(b,a).then(function(a){return c.resolve(a)},function(a){return c.reject(a)})},function(a){return c.reject(a)}),c.promise},q.Update=function(b){var d=a.defer();return c.Put(b,r.update).then(function(a){return d.resolve(a)},function(a){return d.reject(a)}),d.promise},q}]),angular.module("estimateApp").service("LeadTeam",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"teamlead")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").service("LeadDetail",["BaseFactory",function(a){"use strict";
var b=function(){a.constructor.call(this,"leaddetail")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").service("Project",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"project")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").service("ProjectDetail",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"projectdetail")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").service("ProjectDetailStyle",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"projectdetailstyle")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").service("ErrorHandler",[function(){"use strict";function a(a){var b=_.where(c,{dirtyError:a}),e=_.indexOf(d,a);return e>-1?!1:b&&b.length>0?b[0].cleanError:_.contains(a,"duplicate key value violates unique constraint")?"this item already exists":a}var b=this,c=[{dirtyError:'error: duplicate key value violates unique constraint "ix_account_username"',cleanError:"This username is already in use"},{dirtyError:"Nobody here by that name",cleanError:"A user with that username can not be found"},{dirtyError:"missing system id",cleanError:"missing system"},{dirtyError:"missing arealength",cleanError:"missing length"},{dirtyError:"missing areawidth",cleanError:"missing width"}],d=["missing area","missing sale price"];return b.CleanError=function(b){return a(b)},b.ProcessError=function(b,c){var d=!1;if(b){if(b.config&&b.status&&b.config.url&&_.contains(b.config.url,"/api/v1/account/login")&&404===b.status&&(c.push("user not found"),d=!0),!d&&b.data){var e=b.data.error;if(e){if(!d&&-1===e.indexOf("[")){var f=e.replace(/"/g,"").replace(/, /g,",").split(",");_.each(f,function(b){var d=a(b);d&&c.push(d)}),d=!0}d||0!==e.indexOf("[")?!d&&e&&(c.push(e),d=!0):(e=JSON.parse(e),angular.forEach(e,function(b){c.push(a(b))}),d=!0)}}!d&&b.length>0&&angular.forEach(b,function(b){c.push(a(b))})}},b}]),angular.module("estimateApp").service("Person",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"person")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").service("Address",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"address")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").service("Phone",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"phone")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").service("Note",["BaseFactory",function(a){"use strict";var b=function(){a.constructor.call(this,"note")};return b.prototype=Object.create(a.constructor.prototype),b.prototype.constructor=b,new b}]),angular.module("estimateApp").factory("BaseFactory",["Service",function(a){"use strict";function b(a){this.url={search:"api/v1/"+a+"/search",add:"api/v1/"+a,update:"api/v1/"+a,remove:"api/v1/"+a}}return b.prototype.Get=function(b){var c={},d=[];return d.push({id:b}),c.criteria=d,a.Post(c,this.url.search)},b.prototype.Search=function(b,c){var d={},e={searchType:"use",populate:!0};return c&&(e=c),d.hints=e,d.criteria=b,a.Post(d,this.url.search)},b.prototype.Add=function(b){return a.Post(b,this.url.add)},b.prototype.Update=function(b){return a.Put(b,this.url.update)},b.prototype.Remove=function(b){return a.Remove(b,this.url.remove)},new b}]),angular.module("estimateApp").service("Storage",["Service","BaseFactory",function(a){"use strict";var b=this,c={search:"api/v1/storage/search",add:"api/v1/storage",update:"api/v1/storage",remove:"api/v1/storage"};return b.GetFileImageString=function(b){return a.GetOne(c.add+"/"+b)},b.Get=function(b){var d={},e=[];return e.push({id:b}),d.criteria=e,a.Post(d,c.search)},b.Search=function(b,d){var e={},f={searchType:"use",populate:!0};return d&&(f=d),e.hints=f,e.criteria=b,a.Post(e,c.search)},b.Add=function(b){return a.Post(b,c.add)},b.Update=function(b){return a.Put(b,c.update)},b.Remove=function(b){return a.Remove(b,c.remove)},b}]),angular.module("estimateApp").directive("jSignature",["$timeout",function(a){"use strict";return{restrict:"EA",scope:{model:"=jSignature",penColor:"@",lineColor:"@",readonly:"=",data:"="},link:function(b,c){var d=(b.data,function(){var a="position:absolute;display:none;margin:0 !important;top:auto",b=$('<button type="button" class="btn btn-xs btn-default" style="'+a+'">Undo Last Stroke</button>').appendTo(this.$controlbarLower),c=b.width();return b.css("left",Math.round((this.canvas.width-c)/2)),b}),e={UndoButton:d};b.lineColor&&(e["decor-color"]=b.lineColor),b.penColor&&(e.color=b.penColor),c.jSignature(e),b.$watch("model",function(a){if("undefined"!=typeof a);}),b.$watch("readonly",function(a){a===!0?(c.jSignature("disable"),c.find("button").css({display:"none"})):c.jSignature("enable")}),b.$watch("data",function(){}),c.bind("change",function(){a(function(){b.data="";var a=c.jSignature("getData","svgbase64"),d=a.join(",");b.data=d,b.model=d},100,!0)})}}}]);